---
/**
 * GlassCard.astro - Shared glassmorphism card component (SIMPLIFIED)
 *
 * Props:
 * - variant: 'default' | 'active' — Card style
 * - clickable: boolean — Enables hover effects
 * - href: string — Makes the card a link
 * - id: string — Element ID
 * - class: string — Additional CSS classes
 * - as: string — HTML element tag (default: auto-detected)
 * - backgroundColor: string — Custom background (CSS value)
 * - borderColor: string — Custom border color
 * - accentColor: string — Accent color for hover/active states
 * - padding: 'none' | 'sm' | 'md' | 'lg' — Padding size (default: 'md')
 * - rounded: 'none' | 'sm' | 'md' | 'lg' | 'full' — Border radius (default: 'md')
 * - intensity: number — Multiplier for glass thickness (0-2)
 * - toggleable: boolean — Click toggles state
 * - toggleId: string — ID for toggle events
 * - toggled: boolean — Initial toggle state
 */

interface Props {
  variant?: "default" | "active";
  clickable?: boolean;
  href?: string;
  id?: string;
  class?: string;
  as?: string;
  backgroundColor?: string;
  borderColor?: string;
  accentColor?: string;
  padding?: "none" | "sm" | "md" | "lg";
  rounded?: "none" | "sm" | "md" | "lg" | "full";
  intensity?: number;
  toggleable?: boolean;
  toggleId?: string;
  toggled?: boolean;
}

const {
  variant = "default",
  clickable = false,
  href,
  id,
  class: className,
  as,
  backgroundColor,
  borderColor,
  accentColor,
  padding = "md",
  rounded = "md",
  intensity = 1,
  toggleable = false,
  toggleId,
  toggled = false,
  ...restProps
} = Astro.props;

const Tag = as || (href ? "a" : "div");

// Build class list
const classes = [
  "glass-card",
  `glass-card--${variant}`,
  `glass-card--p-${padding}`,
  `glass-card--r-${rounded}`,
  clickable || toggleable ? "glass-card--clickable" : "",
  toggleable ? "glass-card--toggleable" : "",
  toggled ? "glass-card--toggled" : "",
  className || "",
]
  .filter(Boolean)
  .join(" ");

// Build inline styles
const styles = [
  accentColor ? `--card-accent: ${accentColor}` : "",
  backgroundColor ? `--panel-bg: ${backgroundColor}` : "",
  borderColor ? `--card-border: ${borderColor}` : "",
  `--card-opacity: ${intensity}`,
]
  .filter(Boolean)
  .join("; ");
---

<Tag
  {...restProps}
  id={id}
  class={classes}
  href={href}
  target={href ? "_blank" : undefined}
  rel={href ? "noopener noreferrer" : undefined}
  role={clickable && !href ? "button" : undefined}
  tabindex={clickable || toggleable ? 0 : undefined}
  style={styles || undefined}
  data-toggle-id={toggleable ? toggleId : undefined}
  data-toggled={toggleable ? String(toggled) : undefined}
  onclick={toggleable
    ? "this.dispatchEvent(new CustomEvent('toggle-click', {bubbles: true}))"
    : undefined}
>
  <slot />
</Tag>

<script>
  // Toggle handler (runs once globally)
  function initToggle() {
    document.addEventListener("toggle-click", (e) => {
      const card = e.target as HTMLElement;
      if (!card.hasAttribute("data-toggle-id")) return;

      const id = card.dataset.toggleId;
      const isOn = card.dataset.toggled === "true";
      const newState = !isOn;

      card.dataset.toggled = String(newState);
      card.classList.toggle("glass-card--toggled", newState);

      document.dispatchEvent(
        new CustomEvent("card-toggled", {
          detail: { id, toggled: newState, card },
        })
      );
    });

    // Keyboard support
    document.addEventListener("keydown", (e) => {
      const target = e.target as HTMLElement;
      if (!target.classList.contains("glass-card--toggleable")) return;
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        target.click();
      }
    });
  }

  if (typeof window !== "undefined") {
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initToggle);
    } else {
      initToggle();
    }
  }
</script>

<style>
  /* ========== BASE CARD ========== */
  .glass-card {
    --card-accent: var(--color-accent, #6366f1);
    --card-bg: rgba(255, 255, 255, calc(0.03 * var(--card-opacity, 1)));
    --card-border: rgba(255, 255, 255, calc(0.1 * var(--card-opacity, 1)));

    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;

    background: var(--card-bg);
    border: 1px solid var(--card-border);
    backdrop-filter: blur(var(--depth-blur, 24px));
    -webkit-backdrop-filter: blur(var(--depth-blur, 24px));

    position: relative;
    transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
    box-sizing: border-box;
    box-shadow: none;
    text-decoration: none;
    color: inherit;
    font-family: inherit;
    cursor: default;
    overflow: hidden;
  }

  /* Padding variants */
  .glass-card--p-none {
    padding: 0;
  }
  .glass-card--p-sm {
    padding: 0.5rem;
  }
  .glass-card--p-md {
    padding: 1rem;
  }
  .glass-card--p-lg {
    padding: 1.5rem;
  }

  /* Border radius variants */
  .glass-card--r-none {
    border-radius: 0;
  }
  .glass-card--r-sm {
    border-radius: 8px;
  }
  .glass-card--r-md {
    border-radius: 16px;
  }
  .glass-card--r-lg {
    border-radius: 24px;
  }
  .glass-card--r-full {
    border-radius: 9999px;
  }

  /* Dark mode override */
  @media (prefers-color-scheme: dark) {
    .glass-card {
      --card-bg: rgba(255, 255, 255, calc(0.02 * var(--card-opacity, 1)));
      --card-border: rgba(255, 255, 255, calc(0.08 * var(--card-opacity, 1)));
    }
  }

  /* ========== CLICKABLE ========== */
  .glass-card--clickable {
    cursor: pointer;
  }

  .glass-card--clickable:hover {
    z-index: 10;
    border-color: var(--card-accent);
  }

  @media (prefers-color-scheme: dark) {
    .glass-card--clickable:hover {
      border-color: var(--card-accent);
    }
  }

  /* ========== ACTIVE VARIANT ========== */
  .glass-card--active {
    border-color: var(--card-accent);
  }

  /* ========== TOGGLED STATE ========== */
  .glass-card--toggled {
    border-color: var(--card-accent);
  }

  /* ========== BUTTON RESET ========== */
  .glass-card:is(button) {
    appearance: none;
    -webkit-appearance: none;
    outline: none;
    border: 1px solid var(--card-border);
  }
</style>
