---
/**
 * ConfigMenu.astro - Floating configuration orb with settings menu
 *
 * Props:
 * - currentLang: Current language code
 * - languages: Available languages
 * - homeHref: Link to home (default: "/")
 */

interface Language {
  readonly code: string;
  readonly name: string;
}

interface Props {
  currentLang: string;
  languages: readonly Language[];
  homeHref?: string;
  changelogId?: string;
}

const { currentLang, languages, homeHref = "/", changelogId } = Astro.props;

import GlassCard from "./GlassCard.astro";
import Icon from "./Icon.astro";
---

<!-- Orb Container (Draggable) -->
<div class="orb-container" data-draggable="true" data-persist-id="main-orb">
  <!-- Orb Button -->
  <GlassCard
    as="button"
    class="orb-btn"
    padding="none"
    rounded="full"
    shadow={false}
    toggleable={true}
    toggleId="main-menu"
    aria-label="Menu"
  >
    <Icon name="settings" class="settings-icon" />
  </GlassCard>

  <!-- Dropdown Menu -->
  <nav class="orb-menu" aria-label="Main Menu">
    <!-- Navigation -->
    <section class="menu-section">
      <h3 class="menu-label">Navigation</h3>
      <a href={homeHref} class="menu-item">
        <Icon name="home" size={16} />
        <span>Home</span>
      </a>
      <a href="https://holi.tools" class="menu-item">
        <Icon name="apps" size={16} />
        <span>More Tools</span>
      </a>
    </section>

    <hr class="menu-divider" />

    <!-- Actions -->
    <section class="menu-section">
      <h3 class="menu-label">Holi.tools</h3>
      <a href={`/${currentLang}/papers`} class="menu-item">
        <Icon name="article" size={16} />
        <span>Papers</span>
      </a>
      {
        changelogId && (
          <button
            class="menu-item"
            onclick={`window.openOverlay && window.openOverlay('changelog', '${changelogId}')`}
          >
            <Icon name="history" size={16} />
            <span>Versions</span>
          </button>
        )
      }
      <button
        class="menu-item"
        onclick="window.openOverlay && window.openOverlay('info', 'about')"
      >
        <Icon name="info" size={16} />
        <span>About</span>
      </button>
      <a
        href="https://github.com/sponsors/EasyModeLife"
        target="_blank"
        rel="noopener"
        class="menu-item"
      >
        <Icon name="favorite" size={16} />
        <span>Support / Donate</span>
      </a>
      <a
        href="https://github.com/EasyModeLife/holi.tools"
        target="_blank"
        rel="noopener"
        class="menu-item"
      >
        <Icon name="code" size={16} />
        <span>Source Code</span>
      </a>
    </section>

    <hr class="menu-divider" />

    <!-- Languages -->
    <section class="menu-section">
      <h3 class="menu-label">Language</h3>
      <div class="lang-grid">
        {
          languages.map((l: Language) => (
            <a
              href={l.code === "en" ? "/" : `/${l.code}/`}
              class={`lang-chip ${l.code === currentLang ? "active" : ""}`}
              data-lang={l.code}
              title={l.name}
            >
              {l.code.toUpperCase()}
            </a>
          ))
        }
      </div>
    </section>
  </nav>
</div>

<!-- Draggable Script Import -->
<script>
  import "../scripts/draggable.ts";

  // Close menu on outside click
  document.addEventListener("click", (e) => {
    const container = document.querySelector(".orb-container");
    const orbBtn = document.querySelector(".orb-btn") as HTMLElement | null;
    if (!container || !orbBtn) return;

    if (
      !container.contains(e.target as Node) &&
      orbBtn.dataset.toggled === "true"
    ) {
      orbBtn.dataset.toggled = "false";
      orbBtn.classList.remove("glass-card--toggled");
    }
  });

  // Save language preference
  document.addEventListener("click", (e) => {
    const chip = (e.target as HTMLElement).closest(".lang-chip");
    if (chip) {
      const lang = chip.getAttribute("data-lang");
      if (lang) localStorage.setItem("selectedLang", lang);
    }
  });
</script>

<style>
  /* ========== ORB CONTAINER ========== */
  .orb-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9000;
    cursor: grab;
    touch-action: none;
    user-select: none;
  }

  .orb-container.is-dragging {
    cursor: grabbing;
  }

  /* ========== ORB BUTTON ========== */
  :global(.orb-btn) {
    width: 48px !important;
    height: 48px !important;
    min-height: 0 !important;
  }

  :global(.orb-btn .icon) {
    transition: transform 0.3s ease;
  }

  :global(.orb-btn.glass-card--toggled .icon) {
    transform: rotate(90deg);
  }

  /* ========== DROPDOWN MENU ========== */
  .orb-menu {
    position: absolute;
    top: 56px;
    right: 0;
    width: 200px;

    /* Match GlassCard defaults: 5% opacity, 2px blur */
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(2px);
    -webkit-backdrop-filter: blur(2px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    padding: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);

    opacity: 0;
    transform: scale(0.95) translateY(-8px);
    pointer-events: none;
    transition: all 0.2s ease;

    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  :global(.orb-btn.glass-card--toggled) + .orb-menu {
    opacity: 1;
    transform: scale(1) translateY(0);
    pointer-events: auto;
  }

  @media (prefers-color-scheme: dark) {
    .orb-menu {
      background: rgba(24, 24, 27, 0.05);
      border-color: rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
  }

  /* ========== MENU CONTENT ========== */
  .menu-section {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .menu-label {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    opacity: 0.5;
    margin: 0 0 4px 8px;
    font-weight: 600;
  }

  .menu-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 10px;
    border-radius: 6px;
    font-size: 13px;
    color: inherit;
    text-decoration: none;
    background: transparent;
    border: none;
    cursor: pointer;
    font-family: inherit;
    transition: background 0.15s;
  }

  .menu-item:hover {
    background: rgba(127, 127, 127, 0.1);
  }

  .menu-item .icon {
    opacity: 0.7;
  }

  .menu-divider {
    border: none;
    height: 1px;
    background: rgba(127, 127, 127, 0.15);
    margin: 4px 0;
  }

  /* ========== LANGUAGE GRID ========== */
  .lang-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 4px;
  }

  .lang-chip {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 4px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 700;
    text-decoration: none;
    color: inherit;
    background: transparent;
    border: 1px solid transparent;
    transition: all 0.15s;
  }

  .lang-chip:hover {
    background: rgba(127, 127, 127, 0.15);
  }

  .lang-chip.active {
    background: var(--color-accent, #6366f1);
    color: white;
    border-color: var(--color-accent, #6366f1);
  }

  /* ========== MOBILE ========== */
  @media (max-width: 640px) {
    .orb-container {
      top: 12px;
      right: 12px;
    }

    :global(.orb-btn) {
      width: 40px !important;
      height: 40px !important;
    }

    .orb-menu {
      width: 180px;
    }
  }
</style>
