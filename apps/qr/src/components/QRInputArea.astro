---
/**
 * QRInputArea.astro - Input handling for QR Code content
 *
 * Includes:
 * - content type switcher (URL, Text, WiFi, vCard)
 * - input forms for each type
 * - generate button
 */
import { getIconSvg } from "../lib/icons";
import { getLangFromUrl, useTranslations } from "../i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Pre-render initial icons
const linkIcon = getIconSvg("link", 20);
const chevronDownIcon = getIconSvg("chevron-down", 18);
const arrowRightIcon = getIconSvg("arrow-right", 24);
---

<div class="shared-input-container">
  <!-- Type Switcher Button -->
  <div class="type-switcher-wrapper">
    <button
      class="type-switcher-btn"
      id="type-switcher-btn"
      title={t("input.change_type")}
    >
      <span class="icon type-icon" id="current-type-icon" set:html={linkIcon} />
      <span class="type-label" id="current-type-label">URL</span>
      <span class="icon dropdown-arrow" set:html={chevronDownIcon} />
    </button>

    <!-- Dropdown with ALL types -->
    <div class="type-dropdown" id="type-dropdown">
      <div class="dropdown-section">
        <span class="dropdown-label">{t("input.basic")}</span>
        <button class="type-option active" data-type="url">
          <span class="icon">link</span><span>{t("type.url")}</span>
        </button>
        <button class="type-option" data-type="text">
          <span class="icon">text_fields</span><span>{t("type.text")}</span>
        </button>
      </div>

      <div class="dropdown-section">
        <span class="dropdown-label">{t("input.contact")}</span>
        <button class="type-option" data-type="phone">
          <span class="icon">phone</span><span>{t("type.phone")}</span>
        </button>
        <button class="type-option" data-type="email">
          <span class="icon">email</span><span>{t("type.email")}</span>
        </button>
        <button class="type-option" data-type="sms">
          <span class="icon">sms</span><span>{t("type.sms")}</span>
        </button>
        <button class="type-option" data-type="vcard">
          <span class="icon">contact_page</span><span>{t("type.vcard")}</span>
        </button>
      </div>

      <div class="dropdown-section">
        <span class="dropdown-label">{t("input.utility")}</span>
        <button class="type-option" data-type="wifi">
          <span class="icon">wifi</span><span>{t("type.wifi")}</span>
        </button>
        <button class="type-option" data-type="location">
          <span class="icon">location_on</span><span>{t("type.location")}</span>
        </button>
        <button class="type-option" data-type="event">
          <span class="icon">event</span><span>{t("type.event")}</span>
        </button>
        <button class="type-option" data-type="bitcoin">
          <span class="icon">account_balance_wallet</span><span
            >{t("type.bitcoin")}</span
          >
        </button>
      </div>

      <div class="dropdown-section">
        <span class="dropdown-label">{t("input.social")}</span>
        <button class="type-option" data-type="facebook">
          <span class="icon">public</span><span>{t("type.facebook")}</span>
        </button>
        <button class="type-option" data-type="twitter">
          <span class="icon">chat_bubble</span><span>{t("type.twitter")}</span>
        </button>
        <button class="type-option" data-type="youtube">
          <span class="icon">smart_display</span><span>{t("type.youtube")}</span
          >
        </button>
      </div>

      <div class="dropdown-section">
        <span class="dropdown-label">{t("input.appstores")}</span>
        <button class="type-option" data-type="appstore">
          <span class="icon">apple</span><span>{t("type.appstore")}</span>
        </button>
        <button class="type-option" data-type="playstore">
          <span class="icon">shop</span><span>{t("type.playstore")}</span>
        </button>
      </div>

      <div class="dropdown-section">
        <span class="dropdown-label">{t("input.tools")}</span>
        <button class="type-option" data-type="scan">
          <span class="icon">qr_code_scanner</span><span
            >{t("input.scan_qr")}</span
          >
        </button>
      </div>
    </div>
  </div>

  <!-- Input Templates Container -->
  <div class="input-templates">
    <!-- URL Template (Default) -->
    <div class="input-template active" id="template-url">
      <input
        type="text"
        id="input-url"
        class="input-field"
        placeholder={t("input.placeholder.url")}
        autofocus
      />
    </div>

    <!-- Text Template -->
    <div class="input-template" id="template-text">
      <textarea
        id="input-text"
        class="input-field textarea"
        placeholder={t("input.placeholder.text")}
        rows="3"></textarea>
    </div>

    <!-- WiFi Template -->
    <div class="input-template" id="template-wifi">
      <div class="input-group">
        <input
          type="text"
          id="input-wifi-ssid"
          class="input-field"
          placeholder={t("input.placeholder.wifi_ssid")}
        />
        <input
          type="password"
          id="input-wifi-pass"
          class="input-field"
          placeholder={t("input.placeholder.wifi_pass")}
        />
        <select id="input-wifi-enc" class="input-field select">
          <option value="WPA">{t("input.wifi.wpa")}</option>
          <option value="WEP">{t("input.wifi.wep")}</option>
          <option value="nopass">{t("input.wifi.nopass")}</option>
        </select>
      </div>
    </div>

    <!-- vCard Template -->
    <div class="input-template" id="template-vcard">
      <div class="input-group">
        <input
          type="text"
          id="input-vcard-name"
          class="input-field"
          placeholder={t("input.placeholder.name")}
        />
        <input
          type="tel"
          id="input-vcard-phone"
          class="input-field"
          placeholder={t("input.placeholder.phone")}
        />
        <input
          type="email"
          id="input-vcard-email"
          class="input-field"
          placeholder={t("input.placeholder.email")}
        />
        <input
          type="text"
          id="input-vcard-company"
          class="input-field"
          placeholder={t("input.placeholder.company")}
        />
      </div>
    </div>
    <!-- Email Template -->
    <div class="input-template" id="template-email">
      <div class="input-group">
        <input
          type="email"
          id="input-email-addr"
          class="input-field"
          placeholder={t("input.placeholder.email")}
        />
        <input
          type="text"
          id="input-email-sub"
          class="input-field"
          placeholder={t("input.placeholder.subject")}
        />
        <textarea
          id="input-email-body"
          class="input-field textarea"
          rows="2"
          placeholder={t("input.placeholder.message")}></textarea>
      </div>
    </div>

    <!-- Phone Template -->
    <div class="input-template" id="template-phone">
      <input
        type="tel"
        id="input-phone"
        class="input-field"
        placeholder={t("input.placeholder.phone")}
      />
    </div>

    <!-- SMS Template -->
    <div class="input-template" id="template-sms">
      <div class="input-group">
        <input
          type="tel"
          id="input-sms-phone"
          class="input-field"
          placeholder={t("input.placeholder.phone")}
        />
        <textarea
          id="input-sms-msg"
          class="input-field textarea"
          rows="2"
          placeholder={t("input.placeholder.message")}></textarea>
      </div>
    </div>

    <!-- Location Template -->
    <div class="input-template" id="template-location">
      <div class="input-group">
        <input
          type="text"
          id="input-loc-lat"
          class="input-field"
          placeholder={t("input.placeholder.lat")}
        />
        <input
          type="text"
          id="input-loc-long"
          class="input-field"
          placeholder={t("input.placeholder.long")}
        />
      </div>
    </div>

    <!-- Event Template -->
    <div class="input-template" id="template-event">
      <div class="input-group">
        <input
          type="text"
          id="input-event-title"
          class="input-field"
          placeholder={t("input.placeholder.event_title")}
        />
        <input
          type="datetime-local"
          id="input-event-start"
          class="input-field"
          style="color-scheme: dark;"
        />
        <input
          type="datetime-local"
          id="input-event-end"
          class="input-field"
          style="color-scheme: dark;"
        />
        <input
          type="text"
          id="input-event-loc"
          class="input-field"
          placeholder={t("input.placeholder.location")}
        />
      </div>
    </div>

    <!-- Bitcoin Template -->
    <div class="input-template" id="template-bitcoin">
      <div class="input-group">
        <input
          type="text"
          id="input-btc-addr"
          class="input-field"
          placeholder={t("input.placeholder.btc_addr")}
        />
        <input
          type="text"
          id="input-btc-amount"
          class="input-field"
          placeholder={t("input.placeholder.btc_amount")}
        />
      </div>
    </div>

    <!-- App Store Template -->
    <div class="input-template" id="template-appstore">
      <input
        type="text"
        id="input-appstore"
        class="input-field"
        placeholder={t("input.placeholder.appstore")}
      />
    </div>

    <!-- Play Store Template -->
    <div class="input-template" id="template-playstore">
      <input
        type="text"
        id="input-playstore"
        class="input-field"
        placeholder={t("input.placeholder.playstore")}
      />
    </div>

    <!-- Socials/Generic URL Wrapper (Facebook, Twitter, Youtube, etc) -->
    <!-- We reuse the URL template logic but with placeholders handled by JS? No, separate IDs for clarity -->
    <div class="input-template" id="template-facebook">
      <input
        type="text"
        id="input-fb"
        class="input-field"
        placeholder={t("input.placeholder.fb")}
      />
    </div>
    <div class="input-template" id="template-twitter">
      <input
        type="text"
        id="input-twitter"
        class="input-field"
        placeholder={t("input.placeholder.twitter")}
      />
    </div>
    <div class="input-template" id="template-youtube">
      <input
        type="text"
        id="input-yt"
        class="input-field"
        placeholder={t("input.placeholder.yt")}
      />
    </div>

    <!-- Scan QR Template -->
    <div class="input-template" id="template-scan">
      <div class="scan-upload-area" id="scan-drop-zone">
        <input type="file" id="scan-file-input" accept="image/*" hidden />
        <div class="scan-upload-content">
          <span class="scan-icon">ðŸ“·</span>
          <span class="scan-text">{t("input.scan.drop")}</span>
          <span class="scan-hint">{t("input.scan.hint")}</span>
        </div>
      </div>
      <div class="scan-result" id="scan-result" style="display: none;">
        <div class="scan-result-header">
          <span class="scan-result-icon">âœ…</span>
          <span class="scan-result-label">{t("input.scan.decoded")}</span>
        </div>
        <div class="scan-result-content" id="scan-result-content"></div>
        <div class="scan-result-actions">
          <button
            class="scan-action-btn"
            id="scan-copy-btn"
            title={t("toolbar.copy")}
          >
            <span class="icon">content_copy</span>
          </button>
          <button
            class="scan-action-btn"
            id="scan-open-btn"
            title={t("input.scan.open")}
          >
            <span class="icon">open_in_new</span>
          </button>
          <button
            class="scan-action-btn"
            id="scan-reset-btn"
            title={t("toolbar.reset")}
          >
            <span class="icon">refresh</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Generate Button -->
  <button
    class="btn-action"
    id="generate-btn"
    aria-label={t("toolbar.generate")}
  >
    <span class="icon" set:html={arrowRightIcon} />
  </button>
</div>

<style>
  /* === INPUT BAR CONTAINER === */
  .shared-input-container {
    position: relative;
    top: 20px;
    z-index: 20;
    display: flex;
    align-items: center; /* Center vertically */
    width: 95%;
    max-width: 700px;
    margin-bottom: 32px;
    background: var(--bg-card);
    border: 1px solid var(--border-main);
    border-radius: 20px;
    padding: 8px;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
    transition: all 0.5s ease-out;
  }

  .shared-input-container:focus-within {
    border-color: var(--text-main);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
  }

  /* === TYPE SWITCHER === */
  .type-switcher-wrapper {
    position: relative;
  }

  .type-switcher-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 10px 14px;
    background: rgba(127, 127, 127, 0.05);
    border: 1px solid var(--border-subtle);
    border-radius: 14px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .type-switcher-btn:hover {
    background: rgba(127, 127, 127, 0.1);
    color: var(--text-main);
  }

  .type-switcher-btn .type-icon {
    font-size: 20px;
  }

  .type-switcher-btn .type-label {
    font-size: 13px;
    font-weight: 500;
  }

  .type-switcher-btn .dropdown-arrow {
    font-size: 18px;
    opacity: 0.6;
    transition: transform 0.2s;
  }

  .type-switcher-btn.open .dropdown-arrow {
    transform: rotate(180deg);
  }

  /* Dropdown */
  .type-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    min-width: 180px;
    background: var(--bg-card, #202025);
    /* Improve contrast */
    border: 1px solid var(--border-main);
    border-radius: 16px;
    padding: 8px;
    display: none;
    z-index: 1000; /* Ensure it's above everything */
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
    max-height: 420px;
    overflow-y: auto;

    /* Scrollbar styling */
    scrollbar-width: thin;
    scrollbar-color: var(--border-subtle) transparent;
  }

  .type-dropdown::-webkit-scrollbar {
    width: 6px;
  }
  .type-dropdown::-webkit-scrollbar-thumb {
    background-color: var(--border-subtle);
    border-radius: 3px;
  }

  @media (prefers-color-scheme: dark) {
    .type-dropdown {
      background: #18181b; /* Solid background for legibility */
      border-color: rgba(255, 255, 255, 0.1);
    }
  }

  @media (prefers-color-scheme: dark) {
    .type-dropdown {
      background: rgba(30, 30, 35, 0.95);
    }
  }

  .type-dropdown.open {
    display: block;
    animation: dropdownIn 0.2s ease-out;
  }

  @keyframes dropdownIn {
    from {
      opacity: 0;
      transform: translateY(-8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .dropdown-section {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .dropdown-section + .dropdown-section {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid rgba(127, 127, 127, 0.15);
  }

  .dropdown-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    opacity: 0.5;
    padding: 4px 14px 2px;
    font-weight: 600;
  }

  .type-option {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    padding: 10px 14px;
    background: transparent;
    border: none;
    border-radius: 10px;
    color: var(--text-main, rgba(255, 255, 255, 0.8));
    cursor: pointer;
    transition: all 0.15s;
    text-align: left;
  }

  @media (prefers-color-scheme: dark) {
    .type-option {
      color: rgba(255, 255, 255, 0.8);
    }
  }

  .type-option:hover {
    background: rgba(127, 127, 127, 0.1);
    color: var(--text-main, white);
  }

  .type-option.active {
    background: var(--accent-primary, #1a73e8);
    color: white;
  }

  .type-option .icon {
    font-size: 20px;
  }

  .type-option span:last-child {
    font-size: 14px;
    font-weight: 500;
  }

  /* === INPUT TEMPLATES === */
  .input-templates {
    flex: 1;
    min-width: 0;
  }

  .input-template {
    display: none;
  }

  .input-template.active {
    display: block;
  }

  .input-field {
    width: 100%;
    border: none;
    outline: none;
    font-size: 16px;
    background: transparent;
    color: var(--text-main);
    font-family: var(--font-mono);
    padding: 12px 16px;
  }

  .input-field::placeholder {
    color: var(--text-muted);
  }

  .input-field.textarea {
    resize: none;
    min-height: 80px;
    border-radius: 12px;
    background: rgba(127, 127, 127, 0.03);
    line-height: 1.5;
  }

  .input-field.select {
    background: var(--bg-input, rgba(40, 40, 45, 0.95));
    border-radius: 10px;
    cursor: pointer;
    color: var(--text-main, white);
  }

  @media (prefers-color-scheme: dark) {
    .input-field.select {
      background: rgba(40, 40, 45, 0.95);
      color: white;
    }
  }

  .input-field.select option {
    background: var(--bg-card, #2a2a2f);
    color: var(--text-main, white);
    padding: 8px;
  }

  .input-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .input-group .input-field {
    padding: 10px 14px;
    font-size: 14px;
    border-bottom: 1px solid var(--border-subtle);
  }

  .input-group .input-field:last-child {
    border-bottom: none;
  }

  /* Generate Button */
  .btn-action {
    width: 48px;
    height: 48px;
    min-width: 48px;
    flex-shrink: 0;
    border-radius: 14px;
    background: var(--text-main);
    color: var(--bg-body);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
  }
  .btn-action:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  @media (max-width: 768px) {
    .shared-input-container {
      flex-direction: column;
      align-items: stretch;
      padding: 12px;
      gap: 16px;
    }

    .type-switcher-wrapper {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .type-switcher-btn {
      width: 100%;
      justify-content: space-between;
    }

    .input-templates {
      width: 100%;
    }

    .btn-action {
      width: 100%;
      margin-top: 8px;
    }
  }

  /* === SCAN QR TEMPLATE === */
  .scan-upload-area {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 120px;
    border: 2px dashed rgba(127, 127, 127, 0.3);
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.2s;
    margin: 8px;
  }

  .scan-upload-area:hover,
  .scan-upload-area.dragover {
    border-color: var(--accent-primary, #22c55e);
    background: rgba(34, 197, 94, 0.05);
  }

  .scan-upload-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    text-align: center;
    padding: 20px;
  }

  .scan-icon {
    font-size: 32px;
    opacity: 0.6;
  }

  .scan-text {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-main);
  }

  .scan-hint {
    font-size: 12px;
    opacity: 0.5;
  }

  /* Scan Result */
  .scan-result {
    padding: 16px;
    margin: 8px;
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid rgba(34, 197, 94, 0.3);
    border-radius: 12px;
  }

  .scan-result-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
  }

  .scan-result-icon {
    font-size: 20px;
  }

  .scan-result-label {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--color-success, #22c55e);
  }

  .scan-result-content {
    font-family: var(--font-mono);
    font-size: 14px;
    word-break: break-all;
    background: rgba(0, 0, 0, 0.1);
    padding: 12px;
    border-radius: 8px;
    max-height: 120px;
    overflow-y: auto;
  }

  .scan-result-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
  }

  .scan-action-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 8px 12px;
    background: rgba(127, 127, 127, 0.1);
    border: 1px solid rgba(127, 127, 127, 0.2);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.15s;
    color: var(--text-main);
  }

  .scan-action-btn:hover {
    background: rgba(127, 127, 127, 0.2);
  }

  .scan-action-btn .icon {
    font-size: 18px;
  }
</style>

<script is:inline>
  // === TYPE SWITCHER LOGIC ===
  (function () {
    // Prefetch WASM when the user starts interacting with inputs.
    // This keeps initial page load lighter, but avoids a delay on the first render/export.
    var wasmPrefetchPromise = null;
    var wasmPrefetchScheduled = false;

    function scheduleWasmPrefetchOnce() {
      if (wasmPrefetchScheduled) return;
      wasmPrefetchScheduled = true;

      var run = function () {
        if (wasmPrefetchPromise) return wasmPrefetchPromise;
        wasmPrefetchPromise = import("../lib/wasm-qr-svg-loader")
          .then(function (m) {
            return m.getHoliQrSvg();
          })
          .catch(function () {
            return null;
          });
        return wasmPrefetchPromise;
      };

      // Prefer idle-time prefetch so we don't compete with the first render.
      if (typeof window !== "undefined" && window.requestIdleCallback) {
        window.requestIdleCallback(
          function () {
            run();
          },
          { timeout: 1200 }
        );
      } else {
        // Fallback: slight delay yields to input/render.
        setTimeout(run, 200);
      }
    }

    document.addEventListener(
      "focusin",
      function (e) {
        // Only trigger for this component's input area
        var t = e && e.target;
        if (!t || !t.closest) return;
        if (t.closest(".shared-input-container")) scheduleWasmPrefetchOnce();
      },
      { passive: true }
    );

    const typeSwitcherBtn = document.getElementById("type-switcher-btn");
    const typeDropdown = document.getElementById("type-dropdown");
    const typeIcon = document.getElementById("current-type-icon");
    const typeLabel = document.getElementById("current-type-label");
    const typeOptions = document.querySelectorAll(".type-option");
    const templates = document.querySelectorAll(".input-template");

    // Initialize dropdown icons with SVG (runs after icons.ts is loaded)
    function initDropdownIcons() {
      if (!window.getIconSvg) {
        setTimeout(initDropdownIcons, 50);
        return;
      }
      document
        .querySelectorAll(".type-option .icon")
        .forEach(function (iconEl) {
          var iconName = iconEl.textContent.trim();
          if (iconName && !iconEl.querySelector("svg")) {
            iconEl.innerHTML = window.getIconSvg(iconName, 18);
          }
        });
    }
    initDropdownIcons();

    // Select type from dropdown
    typeOptions.forEach(function (opt) {
      opt.addEventListener("click", function (e) {
        e.stopPropagation();
        const type = opt.getAttribute("data-type");
        if (type && window.setContentType) {
          window.setContentType(type);
        }
        // Close dropdown
        if (typeSwitcherBtn) typeSwitcherBtn.classList.remove("open");
        if (typeDropdown) typeDropdown.classList.remove("open");
      });
    });

    // Set content type function
    window.setContentType = function (type) {
      window.currentContentType = type;

      // Auto-config icon/label from the dropdown option itself (supports localization)
      const opt = document.querySelector(`.type-option[data-type="${type}"]`);
      if (!opt) return;

      const iconEl = opt.querySelector(".icon");
      const labelEl = opt.querySelector("span:last-child");

      const iconName =
        opt.getAttribute("data-icon") ||
        (iconEl ? iconEl.textContent.trim() : "link");
      const labelText = labelEl
        ? labelEl.textContent.trim()
        : type.toUpperCase();

      // Update button display with SVG icon
      if (typeIcon && typeof window.getIconSvg === "function")
        typeIcon.innerHTML = window.getIconSvg(iconName, 20);
      if (typeLabel) typeLabel.textContent = labelText;

      // Update active states in dropdown (if it exists)
      typeOptions.forEach(function (o) {
        o.classList.toggle("active", o.getAttribute("data-type") === type);
      });

      // Switch template
      templates.forEach(function (tpl) {
        tpl.classList.toggle("active", tpl.id === "template-" + type);
      });

      // Dispatch event for parent components to handle logic (like logo injection)
      const event = new CustomEvent("qr-type-changed", {
        detail: { type: type },
      });
      window.dispatchEvent(event);
    };
  })();
</script>
