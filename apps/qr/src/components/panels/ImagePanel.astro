---
/**
 * ImagePanel.astro - Unified Image Management
 * 
 * Combines Logo and Background Art into single panel with:
 * - Quick presets: "Logo" and "Background"
 * - Shared image upload
 * - Mode-specific controls
 */
---

<div class="image-panel-content">
  <!-- Mode Selector (Quick Presets) -->
  <div class="mode-selector">
    <button 
      class="mode-btn active" 
      id="mode-logo" 
      onclick="setImageMode('logo')"
    >
      <span class="mode-icon">üéØ</span>
      <span class="mode-label">Logo</span>
    </button>
    <button 
      class="mode-btn" 
      id="mode-background" 
      onclick="setImageMode('background')"
    >
      <span class="mode-icon">üñºÔ∏è</span>
      <span class="mode-label">Background</span>
    </button>
  </div>

  <!-- Image Upload Area -->
  <div class="image-upload-area" id="image-upload-area">
    <div class="upload-placeholder" id="image-placeholder">
      <div class="upload-icon">üì∑</div>
      <div class="upload-text">Drop image here</div>
      <div class="upload-subtext">or click to browse</div>
      <input
        type="file"
        accept="image/*"
        id="image-input"
        onchange="handleImageUpload(event)"
      />
    </div>

    <div class="image-preview" id="image-preview" style="display:none;">
      <div class="preview-container">
        <img id="preview-img" alt="Preview" />
        <button
          class="preview-remove"
          onclick="removeImage()"
          title="Remove image"
        >√ó</button>
      </div>
      <button
        class="change-btn"
        onclick="document.getElementById('image-input').click()"
      >üîÑ Change</button>
    </div>
  </div>

  <!-- Logo Mode Controls -->
  <div class="controls-section" id="logo-controls" style="display:none;">
    <div class="control-row">
      <label class="control-label">
        Size <span class="control-value" id="logo-size-val">20%</span>
      </label>
      <input
        type="range"
        id="logo-size"
        min="5"
        max="50"
        value="20"
        oninput="updateLogoSize(this.value)"
      />
    </div>
    <div class="control-row">
      <label class="control-label">Background Container</label>
      <label class="toggle-switch">
        <input type="checkbox" id="logo-bg-toggle" checked onchange="updateLogoBg(this.checked)" />
        <span class="toggle-slider"></span>
      </label>
    </div>

    <!-- Shape Controls -->
    <div class="control-group" id="logo-shape-group">
      <label class="control-label">Container Shape</label>
      <div class="fit-buttons">
        <button class="fit-btn active" data-shape="square" onclick="setLogoShape('square')">Square</button>
        <button class="fit-btn" data-shape="rounded" onclick="setLogoShape('rounded')">Rounded</button>
        <button class="fit-btn" data-shape="circle" onclick="setLogoShape('circle')">Circle</button>
      </div>
    </div>

    <!-- Rounded Options -->
    <div class="control-row" id="logo-radius-row" style="display:none;">
      <label class="control-label">
        Corner Radius <span class="control-value" id="logo-radius-val">10</span>
      </label>
      <input
        type="range"
        id="logo-radius"
        min="0"
        max="50"
        value="10"
        oninput="updateLogoRadius(this.value)"
      />
    </div>

    <div class="control-row">
      <label class="control-label">
        Padding <span class="control-value" id="logo-padding-val">0</span>
      </label>
      <input
        type="range"
        id="logo-padding"
        min="0"
        max="50"
        value="0"
        oninput="updateLogoPadding(this.value)"
      />
    </div>
  </div>

  <!-- Background Mode Controls -->
  <div class="controls-section" id="background-controls" style="display:none;">
    <div class="control-row">
      <label class="control-label">
        Opacity <span class="control-value" id="art-opacity-val">100%</span>
      </label>
      <input
        type="range"
        id="art-opacity"
        min="10"
        max="100"
        value="100"
        oninput="updateArtOpacity(this.value)"
      />
    </div>

    <div class="control-group">
      <label class="control-label">Blend Mode</label>
      <div class="blend-buttons">
        <button class="blend-btn active" data-blend="normal" onclick="setArtBlend('normal')">Normal</button>
        <button class="blend-btn" data-blend="multiply" onclick="setArtBlend('multiply')">Multiply</button>
        <button class="blend-btn" data-blend="screen" onclick="setArtBlend('screen')">Screen</button>
        <button class="blend-btn" data-blend="overlay" onclick="setArtBlend('overlay')">Overlay</button>
      </div>
    </div>

    <div class="control-group">
      <label class="control-label">Fit</label>
      <div class="fit-buttons">
        <button class="fit-btn active" data-fit="cover" onclick="setArtFit('cover')">Cover</button>
        <button class="fit-btn" data-fit="contain" onclick="setArtFit('contain')">Contain</button>
        <button class="fit-btn" data-fit="fill" onclick="setArtFit('fill')">Fill</button>
      </div>
    </div>

    <!-- Transform Controls -->
    <div class="transform-section">
      <label class="control-label section-title">Transform</label>
      
      <div class="control-row">
        <label class="control-label">
          Rotation <span class="control-value" id="art-rotation-val">0¬∞</span>
        </label>
        <input
          type="range"
          id="art-rotation"
          min="-180"
          max="180"
          value="0"
          oninput="updateArtRotation(this.value)"
        />
      </div>

      <div class="control-row">
        <label class="control-label">
          Scale <span class="control-value" id="art-scale-val">100%</span>
        </label>
        <input
          type="range"
          id="art-scale"
          min="50"
          max="200"
          value="100"
          oninput="updateArtScale(this.value)"
        />
      </div>

      <div class="offset-row">
        <div class="control-row half">
          <label class="control-label">X</label>
          <input
            type="range"
            id="art-offset-x"
            min="-100"
            max="100"
            value="0"
            oninput="updateArtOffset()"
          />
        </div>
        <div class="control-row half">
          <label class="control-label">Y</label>
          <input
            type="range"
            id="art-offset-y"
            min="-100"
            max="100"
            value="0"
            oninput="updateArtOffset()"
          />
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let currentMode = 'logo';

  function getConfig() {
    return (window as any).state?.config;
  }

  function getCurrentImage(): string | undefined {
    const cfg = getConfig();
    if (!cfg) return undefined;
    return currentMode === 'background' ? cfg.artImage : cfg.logo;
  }

  // Public hook so other components (like the panel system) can force a UI sync
  // after state changes (e.g. presets injecting a logo) or when the panel is opened.
  window.refreshImagePanelUI = function () {
    // Ensure mode button styles match currentMode
    document
      .getElementById('mode-logo')
      ?.classList.toggle('active', currentMode === 'logo');
    document
      .getElementById('mode-background')
      ?.classList.toggle('active', currentMode === 'background');

    updateImageUI(!!getCurrentImage());
  };

  function tryInitImagePanelUI() {
    // state/config might be attached after inline scripts run
    const cfg = getConfig();
    if (!cfg) {
      setTimeout(tryInitImagePanelUI, 50);
      return;
    }
    window.refreshImagePanelUI?.();
  }

  // Best-effort initial sync
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', tryInitImagePanelUI);
  } else {
    tryInitImagePanelUI();
  }
  // Also re-sync after Astro view transitions
  document.addEventListener('astro:page-load', tryInitImagePanelUI);

  window.setImageMode = function(mode: 'logo' | 'background') {
    currentMode = mode;
    
    // Update button states
    document.getElementById('mode-logo')?.classList.toggle('active', mode === 'logo');
    document.getElementById('mode-background')?.classList.toggle('active', mode === 'background');
    
    const cfg = getConfig();
    const hasImage = !!(mode === 'background' ? cfg?.artImage : cfg?.logo);
    
    // Show/hide mode-specific controls
    const logoControls = document.getElementById('logo-controls');
    const bgControls = document.getElementById('background-controls');
    
    if (hasImage) {
      if (mode === 'logo') {
        if (logoControls) logoControls.style.display = 'flex';
        if (bgControls) bgControls.style.display = 'none';
      } else {
        if (logoControls) logoControls.style.display = 'none';
        if (bgControls) bgControls.style.display = 'flex';
      }
    }
    
    // Update render mode without disabling background when editing logo.
    // Background visibility should be controlled by `artEnabled`, not by the UI mode.
    if (cfg) {
      if (mode === 'background') {
        // When entering background mode, auto-enable art if there's an image.
        if (cfg.artImage) cfg.artEnabled = true;
      }
      updateImageUI(hasImage);
      (window as any).updateQR?.();
    }
  };

  window.handleImageUpload = async function(event: Event) {
    const input = event.target as HTMLInputElement;
    const file = input.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      const dataUrl = e.target?.result as string;

      const cfg = getConfig();
      if (!cfg) return;

      // Store ONLY in the active slot
      if (currentMode === 'logo') {
        cfg.logo = dataUrl;
        // Do not disable background art when uploading a logo.

        // Set sensible defaults only if unset
        if (cfg.logoSize === undefined || cfg.logoSize === null) cfg.logoSize = 0.2;
        if (cfg.logoBgEnabled === undefined || cfg.logoBgEnabled === null) cfg.logoBgEnabled = true;
      } else {
        cfg.artImage = dataUrl;
        cfg.artEnabled = true;

        if (cfg.artOpacity === undefined || cfg.artOpacity === null) cfg.artOpacity = 1.0;
        if (!cfg.artBlendMode) cfg.artBlendMode = 'normal';
        if (!cfg.artFit) cfg.artFit = 'cover';
        if (cfg.artRotation === undefined || cfg.artRotation === null) cfg.artRotation = 0;
        if (cfg.artScale === undefined || cfg.artScale === null) cfg.artScale = 1.0;
        if (cfg.artOffsetX === undefined || cfg.artOffsetX === null) cfg.artOffsetX = 0;
        if (cfg.artOffsetY === undefined || cfg.artOffsetY === null) cfg.artOffsetY = 0;
      }

      updateImageUI(true);
      (window as any).updateQR?.();

      // Allow selecting the same file again
      input.value = '';
    };
    reader.readAsDataURL(file);
  };

  window.removeImage = function() {
    const cfg = getConfig();
    if (!cfg) return;

    if (currentMode === 'logo') {
      cfg.logo = undefined;
      // Do not touch art image; user might be using it in background mode.
    } else {
      cfg.artImage = undefined;
      cfg.artEnabled = false;
    }

    updateImageUI(!!getCurrentImage());
    (window as any).updateQR?.();
  };

  function updateImageUI(hasImage: boolean) {
    const placeholder = document.getElementById('image-placeholder');
    const preview = document.getElementById('image-preview');
    const logoControls = document.getElementById('logo-controls');
    const bgControls = document.getElementById('background-controls');
    const img = document.getElementById('preview-img') as HTMLImageElement;
    const area = document.getElementById('image-upload-area');
    
    if (hasImage) {
      if (placeholder) placeholder.style.display = 'none';
      if (preview) preview.style.display = 'flex';
      if (area) area.classList.add('has-image');
      if (img) img.src = getCurrentImage() || '';
      
      // Show controls based on mode
      if (currentMode === 'logo') {
        if (logoControls) logoControls.style.display = 'flex';
        if (bgControls) bgControls.style.display = 'none';
      } else {
        if (logoControls) logoControls.style.display = 'none';
        if (bgControls) bgControls.style.display = 'flex';
      }
    } else {
      if (placeholder) placeholder.style.display = 'flex';
      if (preview) preview.style.display = 'none';
      if (area) area.classList.remove('has-image');
      if (logoControls) logoControls.style.display = 'none';
      if (bgControls) bgControls.style.display = 'none';
    }
  }

  // Logo Controls
  window.updateLogoSize = function(value: number) {
    const size = value / 100;
    document.getElementById('logo-size-val')!.textContent = `${value}%`;
    if ((window as any).state?.config) {
      (window as any).state.config.logoSize = size;
      (window as any).updateQR?.();
    }
  };

  window.updateLogoBg = function(enabled: boolean) {
    // Show/hide shape controls based on bg toggle
    const shapeGroup = document.getElementById('logo-shape-group');
    const paddingRow = document.getElementById('logo-padding').closest('.control-row');
    
    // Actually padding might be useful even without BG? No, padding implies BG.
    // Wait, if no BG, padding just shrinks the image relative to size.
    
    if ((window as any).state?.config) {
      (window as any).state.config.logoBgEnabled = enabled;
      (window as any).updateQR?.();
    }
  };

  window.setLogoShape = function(shape: string) {
    document.querySelectorAll('[data-shape]').forEach(b => b.classList.remove('active'));
    document.querySelector(`[data-shape="${shape}"]`)?.classList.add('active');
    
    const radiusRow = document.getElementById('logo-radius-row');
    if (radiusRow) radiusRow.style.display = shape === 'rounded' ? 'flex' : 'none';
    
    if ((window as any).state?.config) {
      (window as any).state.config.logoBgShape = shape;
      (window as any).updateQR?.();
    }
  };

  window.updateLogoRadius = function(value: number) {
    document.getElementById('logo-radius-val')!.textContent = `${value}`;
    if ((window as any).state?.config) {
      (window as any).state.config.logoCornerRadius = parseInt(value as any);
      (window as any).updateQR?.();
    }
  };

  window.updateLogoPadding = function(value: number) {
    document.getElementById('logo-padding-val')!.textContent = `${value}`;
    if ((window as any).state?.config) {
      (window as any).state.config.logoPadding = parseInt(value as any);
      (window as any).updateQR?.();
    }
  };

  // Background Controls
  window.updateArtOpacity = function(value: number) {
    document.getElementById('art-opacity-val')!.textContent = `${value}%`;
    if ((window as any).state?.config) {
      (window as any).state.config.artOpacity = value / 100;
      (window as any).updateQR?.();
    }
  };

  window.setArtBlend = function(blend: string) {
    document.querySelectorAll('.blend-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`[data-blend="${blend}"]`)?.classList.add('active');
    if ((window as any).state?.config) {
      (window as any).state.config.artBlendMode = blend;
      (window as any).updateQR?.();
    }
  };

  window.setArtFit = function(fit: string) {
    document.querySelectorAll('.fit-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`[data-fit="${fit}"]`)?.classList.add('active');
    if ((window as any).state?.config) {
      (window as any).state.config.artFit = fit;
      (window as any).updateQR?.();
    }
  };

  // Transform Controls  
  window.updateArtRotation = function(value: number) {
    document.getElementById('art-rotation-val')!.textContent = `${value}¬∞`;
    if ((window as any).state?.config) {
      (window as any).state.config.artRotation = parseFloat(value as any);
      (window as any).updateQR?.();
    }
  };

  window.updateArtScale = function(value: number) {
    document.getElementById('art-scale-val')!.textContent = `${value}%`;
    if ((window as any).state?.config) {
      (window as any).state.config.artScale = value / 100;
      (window as any).updateQR?.();
    }
  };

  window.updateArtOffset = function() {
    const x = (document.getElementById('art-offset-x') as HTMLInputElement)?.value || 0;
    const y = (document.getElementById('art-offset-y') as HTMLInputElement)?.value || 0;
    if ((window as any).state?.config) {
      (window as any).state.config.artOffsetX = parseFloat(x as any) / 100;
      (window as any).state.config.artOffsetY = parseFloat(y as any) / 100;
      (window as any).updateQR?.();
    }
  };

  // Drag and drop
  document.addEventListener('DOMContentLoaded', () => {
    const area = document.getElementById('image-upload-area');
    if (!area) return;
    
    area.addEventListener('dragover', (e) => {
      e.preventDefault();
      area.classList.add('dragover');
    });
    
    area.addEventListener('dragleave', () => {
      area.classList.remove('dragover');
    });
    
    area.addEventListener('drop', (e) => {
      e.preventDefault();
      area.classList.remove('dragover');
      
      const file = e.dataTransfer?.files[0];
      if (file?.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          const dataUrl = ev.target?.result as string;
          const cfg = getConfig();
          if (!cfg) return;

          if (currentMode === 'logo') {
            cfg.logo = dataUrl;
            // Do not disable background art when dropping a logo.
            if (cfg.logoSize === undefined || cfg.logoSize === null) cfg.logoSize = 0.2;
            if (cfg.logoBgEnabled === undefined || cfg.logoBgEnabled === null) cfg.logoBgEnabled = true;
          } else {
            cfg.artImage = dataUrl;
            cfg.artEnabled = true;
            if (cfg.artOpacity === undefined || cfg.artOpacity === null) cfg.artOpacity = 1.0;
            if (!cfg.artBlendMode) cfg.artBlendMode = 'normal';
            if (!cfg.artFit) cfg.artFit = 'cover';
            if (cfg.artRotation === undefined || cfg.artRotation === null) cfg.artRotation = 0;
            if (cfg.artScale === undefined || cfg.artScale === null) cfg.artScale = 1.0;
            if (cfg.artOffsetX === undefined || cfg.artOffsetX === null) cfg.artOffsetX = 0;
            if (cfg.artOffsetY === undefined || cfg.artOffsetY === null) cfg.artOffsetY = 0;
          }

          updateImageUI(true);
          (window as any).updateQR?.();
        };
        reader.readAsDataURL(file);
      }
    });
  });
</script>

<style>
  .image-panel-content {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  /* Mode Selector */
  .mode-selector {
    display: flex;
    gap: 8px;
    padding: 4px;
    background: rgba(127, 127, 127, 0.1);
    border-radius: 12px;
  }

  .mode-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 12px 8px;
    background: transparent;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--text-muted, rgba(127, 127, 127, 0.8));
  }

  .mode-btn:hover {
    background: rgba(127, 127, 127, 0.1);
  }

  .mode-btn.active {
    background: var(--color-accent, #6366f1);
    color: white;
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
  }

  .mode-icon {
    font-size: 24px;
  }

  .mode-label {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* Upload Area */
  .image-upload-area {
    position: relative;
    border: 2px dashed rgba(127, 127, 127, 0.3);
    border-radius: 14px;
    background: rgba(127, 127, 127, 0.05);
    transition: all 0.2s ease;
    overflow: hidden;
  }

  .image-upload-area:hover {
    border-color: rgba(127, 127, 127, 0.5);
  }

  .image-upload-area.dragover {
    border-color: var(--color-accent, #6366f1);
    background: rgba(99, 102, 241, 0.1);
  }

  .image-upload-area.has-image {
    border-style: solid;
  }

  .upload-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 32px 16px;
    cursor: pointer;
    position: relative;
  }

  .upload-placeholder input {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
  }

  .upload-icon {
    font-size: 36px;
    opacity: 0.8;
  }

  .upload-text {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-main);
  }

  .upload-subtext {
    font-size: 12px;
    color: var(--text-muted);
  }

  /* Preview */
  .image-preview {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    padding: 16px;
  }

  .preview-container {
    position: relative;
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .preview-container img {
    max-width: 100%;
    max-height: 100%;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    object-fit: contain;
  }

  .preview-remove {
    position: absolute;
    top: -8px;
    right: -8px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #ef4444;
    border: 2px solid white;
    color: white;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  }

  .preview-remove:hover {
    transform: scale(1.15);
  }

  .change-btn {
    padding: 8px 14px;
    background: rgba(127, 127, 127, 0.1);
    border: 1px solid rgba(127, 127, 127, 0.2);
    border-radius: 8px;
    color: var(--text-main);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .change-btn:hover {
    background: rgba(127, 127, 127, 0.2);
  }

  /* Controls */
  .controls-section {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .control-row {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .control-row.half {
    flex: 1;
  }

  .offset-row {
    display: flex;
    gap: 12px;
  }

  .control-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .control-label.section-title {
    font-size: 11px;
    margin-bottom: 4px;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(127, 127, 127, 0.1);
  }

  .control-value {
    font-weight: 600;
    color: var(--text-main);
  }

  input[type="range"] {
    width: 100%;
    height: 6px;
    background: rgba(127, 127, 127, 0.2);
    border-radius: 3px;
    outline: none;
    -webkit-appearance: none;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    background: var(--text-main, white);
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  /* Button Groups */
  .control-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .blend-buttons,
  .fit-buttons {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  .blend-btn,
  .fit-btn {
    flex: 1;
    min-width: 60px;
    padding: 8px 10px;
    background: rgba(127, 127, 127, 0.1);
    border: 1px solid rgba(127, 127, 127, 0.2);
    border-radius: 8px;
    color: var(--text-muted);
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.15s;
  }

  .blend-btn:hover,
  .fit-btn:hover {
    background: rgba(127, 127, 127, 0.2);
    color: var(--text-main);
  }

  .blend-btn.active,
  .fit-btn.active {
    background: var(--color-accent, #6366f1);
    border-color: var(--color-accent, #6366f1);
    color: white;
  }

  /* Toggle Switch */
  .toggle-switch {
    position: relative;
    width: 44px;
    height: 24px;
  }

  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .toggle-slider {
    position: absolute;
    cursor: pointer;
    inset: 0;
    background: rgba(127, 127, 127, 0.3);
    border-radius: 24px;
    transition: 0.2s;
  }

  .toggle-slider::before {
    content: "";
    position: absolute;
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background: white;
    border-radius: 50%;
    transition: 0.2s;
  }

  .toggle-switch input:checked + .toggle-slider {
    background: var(--color-accent, #6366f1);
  }

  .toggle-switch input:checked + .toggle-slider::before {
    transform: translateX(20px);
  }

  .transform-section {
    padding-top: 12px;
    border-top: 1px solid rgba(127, 127, 127, 0.1);
  }
</style>
