---
import BaseLayout from "../../../../packages/ui/src/layouts/BaseLayout.astro";
import HeroTitle from "../components/HeroTitle.astro";
import HeroValues from "../components/HeroValues.astro";
import ToolsExplorer from "../components/ToolsExplorer.astro";
import Overlay from "../components/Overlay.astro";
import SoundEngine from "../components/SoundEngine.astro";
import GlassHeader from "../../../../packages/ui/src/components/GlassHeader.astro";
import { getTranslations, languages } from "../i18n/translations";

const lang = Astro.currentLocale || "en";
const t = getTranslations(lang);

// Build canonical URL and hreflang alternates
const baseUrl = "https://holi.tools";
const currentPath = lang === "en" ? "/" : `/${lang}/`;
const canonicalUrl = `${baseUrl}${currentPath}`;

// Generate hreflang links for all languages
const hreflangLinks = languages.map((l) => ({
  lang: l.code,
  href: l.code === "en" ? baseUrl + "/" : `${baseUrl}/${l.code}/`,
}));
---

<BaseLayout
  title={`Holi.tools - ${t.hero_slogan}`}
  description={t.info_privacy_text}
  lang={lang}
  languages={languages}
  colorScheme="default"
  showLanguageMenu={true}
  showCanvasGrid={true}
>
  <slot name="head" slot="head">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="manifest" href="/manifest.webmanifest" />

    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalUrl} />

    <!-- Hreflang alternates for SEO -->
    {
      hreflangLinks.map((link) => (
        <link rel="alternate" hreflang={link.lang} href={link.href} />
      ))
    }
    <link rel="alternate" hreflang="x-default" href={baseUrl + "/"} />

    <!-- Open Graph Meta Tags -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:title" content={`Holi.tools - ${t.hero_slogan}`} />
    <meta property="og:description" content={t.info_privacy_text} />
    <meta property="og:image" content={`${baseUrl}/og-image.svg`} />
    <meta property="og:locale" content={lang} />
    <meta property="og:site_name" content="Holi.tools" />

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={`Holi.tools - ${t.hero_slogan}`} />
    <meta name="twitter:description" content={t.info_privacy_text} />
    <meta name="twitter:image" content={`${baseUrl}/og-image.svg`} />

    <!-- Theme color for mobile browsers -->
    <meta name="theme-color" content="#1a1a1a" />

    <!-- Schema.org JSON-LD Structured Data -->
    <script
      type="application/ld+json"
      set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "WebApplication",
        name: "Holi.tools",
        description: t.info_privacy_text,
        url: baseUrl,
        applicationCategory: "UtilitiesApplication",
        operatingSystem: "Web Browser",
        offers: {
          "@type": "Offer",
          price: "0",
          priceCurrency: "USD",
        },
        author: {
          "@type": "Organization",
          name: "EasyModeLife",
          url: "https://github.com/EasyModeLife",
        },
        license: "https://www.gnu.org/licenses/agpl-3.0.html",
        isAccessibleForFree: true,
        inLanguage: languages.map((l) => l.code),
      })}
    />
  </slot>

  <!-- Skip Link for Accessibility -->
  <a href="#ToolsExplorer" class="skip-link"
    >{t.skip_to_content || "Skip to main content"}</a
  >

  <GlassHeader
    leftIcon="info"
    leftId="btn-about"
    leftTitle="About Holi.tools"
    leftOnClick="openOverlay('info', 'privacy')"
    centerHref="https://holi.tools"
    centerIcon="â˜­"
    centerLabel="holi.tools"
    rightIcon="favorite"
    rightId="btn-donate"
    rightTitle="Support Holi.tools"
    rightOnClick="window.open('https://github.com/sponsors/EasyModeLife', '_blank')"
  />

  <div class="dvh-container">
    <header class="main-header">
      <HeroTitle />
      <HeroValues />
    </header>

    <ToolsExplorer />
  </div>

  <Overlay />
  <SoundEngine />

  <script>
    // FORCE UNREGISTER SERVICE WORKER TO CLEAR STALE CACHE
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.getRegistrations().then(function (registrations) {
        for (let registration of registrations) {
          registration.unregister();
          console.log("Service Worker Unregistered to force update");
        }
      });
    }
  </script>

  <script define:vars={{ t, languages, lang }}>
    // Clientside logic for the overlay and simple I18N bridges
    window.I18N = {
      lang,
      t,
      languages,
    };

    function openOverlay(type, id = "") {
      const body = document.getElementById("OverlayBody");
      const container = document.getElementById("OverlaySystem");

      if (!body || !container) return;

      if (type === "languages") {
        document.getElementById("lang-trigger")?.click();
      } else if (type === "info") {
        const title = window.I18N.t[`info_${id}_title`] || id;
        const text = window.I18N.t[`info_${id}_text`] || "...";
        body.innerHTML = `
          <h2 class="overlay-title">${title}</h2>
          <p class="overlay-text">${text}</p>
        `;
        container.classList.add("active");

        // Focus management
        const firstFocusable = container.querySelector(
          'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
        if (firstFocusable) {
          setTimeout(() => firstFocusable.focus(), 100);
        }
      }
    }

    // Expose to window for inline onlick handlers
    window.openOverlay = openOverlay;

    // Event Delegation
    document.addEventListener("click", (e) => {
      const target = e.target;
      if (!target) return;

      const item = target.closest(".glass-prop-item");
      if (item) {
        const id = item.id;
        // All cards now use info overlay
        openOverlay("info", id);
        return;
      }

      if (target.id === "CloseOverlay" || target.id === "OverlaySystem") {
        const overlay = document.getElementById("OverlaySystem");
        if (overlay) overlay.classList.remove("active");
      }
    });

    // Keyboard support for overlay close (Escape key)
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        const overlay = document.getElementById("OverlaySystem");
        if (overlay && overlay.classList.contains("active")) {
          overlay.classList.remove("active");
        }
      }
    });
  </script>

  <style>
    /* Skip Link for Accessibility */
    .skip-link {
      position: absolute;
      top: -100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--color-text);
      color: var(--color-bg);
      padding: 0.75rem 1.5rem;
      font-weight: 700;
      text-decoration: none;
      z-index: 10000;
      border: 2px solid var(--color-border);
      transition: top 0.2s ease;
    }
    .skip-link:focus {
      top: 1rem;
    }

    .dvh-container {
      display: flex;
      flex-direction: column;
      min-height: 100dvh;
    }

    .main-header {
      background: transparent;
      width: 100%;
      min-height: 60dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      transition: background-color 0.3s ease;
      padding: 8rem 1rem 4rem 1rem;
      gap: 3rem;
      box-sizing: border-box;
    }
  </style>

  <style is:global>
    /* Global Overlay Content Styles (Must be global because they are injected via JS) */
    .overlay-title {
      font-size: clamp(1.5rem, 6vw, 3rem);
      font-weight: 900;
      text-transform: lowercase;
      margin-bottom: 2rem;
      line-height: 0.9;
      border-bottom: 4px solid var(--color-border);
      padding-bottom: 0.5rem;
      display: inline-block;
      color: var(--color-text);
    }
    .overlay-text {
      font-size: clamp(1rem, 2.5vw, 1.3rem);
      line-height: 1.5;
      color: var(--color-text);
      font-weight: 400;
    }
  </style>
</BaseLayout>
