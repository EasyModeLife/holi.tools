---
---
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<title>Vault & Crypto - Holi.tools</title>
	</head>
	<body class="bg-background text-foreground min-h-screen p-8 max-w-2xl mx-auto">
    <header class="mb-8">
      <h1 class="text-3xl font-bold">Vault & Crypto Lab</h1>
      <p class="text-muted-foreground mt-2">Testing Identity (Ed25519) and Project Encryption (XChaCha20-Poly1305)</p>
    </header>

    <div class="space-y-6">
      <!-- Identity Section -->
      <div class="p-6 rounded-xl border bg-card">
        <h2 class="text-xl font-semibold mb-4">Identity (Ed25519)</h2>
        <div class="flex items-center gap-4">
          <button id="gen-id-btn" class="px-4 py-2 bg-primary text-primary-foreground rounded-md hover:opacity-90 transition-opacity">
            Generate New Identity
          </button>
          <div id="identity-output" class="font-mono text-xs bg-muted p-2 rounded flex-1 break-all">
            No identity loaded.
          </div>
        </div>
      </div>

      <!-- Handshake Simulator -->
      <div class="p-6 rounded-xl border bg-card">
        <h2 class="text-xl font-semibold mb-4">P2P Handshake Simulation</h2>
        <p class="text-sm text-muted-foreground mb-4">Simulate Alice verifying Bob via Challenge/Response.</p>
        
        <div class="space-y-4">
          <button id="hs-init-btn" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:opacity-90">1. Initialize Peers (Alice & Bob)</button>
          <div class="grid grid-cols-2 gap-4 text-xs font-mono">
             <div class="p-2 bg-muted rounded">Alice Pub: <span id="hs-alice-pub">...</span></div>
             <div class="p-2 bg-muted rounded">Bob Pub: <span id="hs-bob-pub">...</span></div>
          </div>

          <button id="hs-challenge-btn" class="px-4 py-2 bg-yellow-600 text-white rounded-md hover:opacity-90" disabled>2. Alice Generates Challenge</button>
          <div class="p-2 bg-muted rounded text-xs font-mono break-all">Challenge: <span id="hs-challenge">...</span></div>

          <button id="hs-sign-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:opacity-90" disabled>3. Bob Signs Challenge</button>
          <div class="p-2 bg-muted rounded text-xs font-mono break-all">Signature: <span id="hs-signature">...</span></div>

          <button id="hs-verify-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:opacity-90" disabled>4. Alice Verifies</button>
          <div id="hs-result" class="font-bold"></div>
        </div>
      </div>

      <!-- Encryption Section -->
      <div class="p-6 rounded-xl border bg-card">
        <h2 class="text-xl font-semibold mb-4">Project Encryption (XChaCha20)</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Project ID</label>
            <input type="text" id="project-id" value="my-secret-project" class="w-full px-3 py-2 bg-background border rounded-md" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Data to Encrypt</label>
            <textarea id="plaintext" class="w-full h-24 px-3 py-2 bg-background border rounded-md" placeholder="Enter sensitive data here..."></textarea>
          </div>
          <div class="flex gap-2">
            <button id="encrypt-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:opacity-90">Encrypt</button>
            <button id="decrypt-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:opacity-90">Decrypt</button>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Ciphertext (Hex)</label>
            <textarea id="ciphertext" class="w-full h-24 px-3 py-2 bg-muted border rounded-md font-mono text-xs" readonly></textarea>
          </div>
          <div>
             <label class="block text-sm font-medium mb-1">Decrypted Output</label>
             <div id="decrypted-output" class="p-3 bg-muted border rounded-md min-h-[40px]"></div>
          </div>
        </div>
      </div>
      <!-- ProjectKey Test Section -->
      <div class="p-6 rounded-xl border bg-card">
        <h2 class="text-xl font-semibold mb-4">Direct ProjectKey Test (Experimental)</h2>
        <p class="text-sm text-muted-foreground mb-4">Test the raw ProjectKey WASM binding.</p>
        <button id="raw-key-gen-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:opacity-90">Generate & Test Raw Key</button>
        <div id="raw-key-output" class="mt-4 p-3 bg-muted rounded text-xs font-mono break-all"></div>
      </div>
    </div>

    <script>
      import init, { Vault, HandshakeSimulator, ProjectKey } from "@holi/wasm-core";

      let vault = null;
      let hsSim = null;

      function toHex(buffer) {
        return Array.from(new Uint8Array(buffer))
          .map(b => b.toString(16).padStart(2, "0"))
          .join("");
      }

      function fromHex(hexString) {
        return new Uint8Array(hexString.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
      }

      async function run() {
        await init();
        
        // --- Raw ProjectKey Logic ---
        const rawKeyBtn = document.getElementById('raw-key-gen-btn');
        const rawKeyOut = document.getElementById('raw-key-output');

        rawKeyBtn.onclick = () => {
          try {
            const key = new ProjectKey();
            const bytes = key.to_bytes();
            const text = "Secret Message 123";
            const encrypted = key.encrypt(new TextEncoder().encode(text));
            const decrypted = key.decrypt(encrypted);
            const decoded = new TextDecoder().decode(decrypted);

            rawKeyOut.innerHTML = `
              <div>Key Bytes: ${toHex(bytes)}</div>
              <div class="mt-2 text-green-500">Encryption/Decryption Loop: ${decoded === text ? "PASSED" : "FAILED"}</div>
            `;
          } catch (e) {
            rawKeyOut.innerText = "Error: " + e;
          }
        };

        // --- Vault Logic ---
        const genIdBtn = document.getElementById('gen-id-btn');
        const idOutput = document.getElementById('identity-output');
        const encryptBtn = document.getElementById('encrypt-btn');
        const decryptBtn = document.getElementById('decrypt-btn');
        const projectIdInput = document.getElementById('project-id');
        const plaintextInput = document.getElementById('plaintext');
        const ciphertextOutput = document.getElementById('ciphertext');
        const decryptedOutput = document.getElementById('decrypted-output');

        vault = Vault.new();
        idOutput.textContent = "Vault Initialized. Public Key: " + vault.get_identity_public_key();

        genIdBtn.onclick = () => {
          vault = Vault.new();
          idOutput.textContent = "New Identity Generated. Public Key: " + vault.get_identity_public_key();
          const pid = projectIdInput.value;
          vault.create_project(pid);
        };

        vault.create_project(projectIdInput.value);

        encryptBtn.onclick = () => {
          const pid = projectIdInput.value;
          const text = plaintextInput.value;
          const encoder = new TextEncoder();
          const data = encoder.encode(text);

          try {
            const encrypted = vault.encrypt_project_data(pid, data);
            ciphertextOutput.value = toHex(encrypted);
            decryptedOutput.textContent = "";
          } catch (e) {
            alert("Encryption failed: " + e);
          }
        };

        decryptBtn.onclick = () => {
          const pid = projectIdInput.value;
          const hex = ciphertextOutput.value;
          if (!hex) return;

          try {
            const encryptedData = fromHex(hex);
            const decrypted = vault.decrypt_project_data(pid, encryptedData);
            const decoder = new TextDecoder();
            decryptedOutput.textContent = decoder.decode(decrypted);
          } catch (e) {
            alert("Decryption failed: " + e);
          }
        };

        // --- Handshake Simulation Logic ---
        const hsInitBtn = document.getElementById('hs-init-btn');
        const hsChalBtn = document.getElementById('hs-challenge-btn');
        const hsSignBtn = document.getElementById('hs-sign-btn');
        const hsVerBtn = document.getElementById('hs-verify-btn');
        const hsAlicePub = document.getElementById('hs-alice-pub');
        const hsBobPub = document.getElementById('hs-bob-pub');
        const hsChallenge = document.getElementById('hs-challenge');
        const hsSignature = document.getElementById('hs-signature');
        const hsResult = document.getElementById('hs-result');

        hsInitBtn.onclick = () => {
          hsSim = HandshakeSimulator.new();
          hsAlicePub.innerText = hsSim.get_alice_pub().substring(0, 16) + "...";
          hsBobPub.innerText = hsSim.get_bob_pub().substring(0, 16) + "...";
          hsChalBtn.disabled = false;
          hsChallenge.innerText = "...";
          hsSignature.innerText = "...";
          hsResult.innerText = "";
        };

        hsChalBtn.onclick = () => {
          if(!hsSim) return;
          const c = hsSim.alice_generates_challenge();
          hsChallenge.innerText = c;
          hsSignBtn.disabled = false;
        };

        hsSignBtn.onclick = () => {
          if(!hsSim) return;
          const s = hsSim.bob_signs_challenge();
          hsSignature.innerText = s;
          hsVerBtn.disabled = false;
        };

        hsVerBtn.onclick = () => {
          if(!hsSim) return;
          const sig = hsSignature.innerText;
          const valid = hsSim.alice_verifies_bob(sig);
          if (valid) {
            hsResult.innerText = "✅ Verification SUCCESS! Bob is authenticated.";
            hsResult.className = "font-bold text-green-600";
          } else {
            hsResult.innerText = "❌ Verification FAILED!";
            hsResult.className = "font-bold text-red-600";
          }
        };
      }

      run();
    </script>
	</body>
</html>