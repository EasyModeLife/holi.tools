---
import VaultLayout from "../../layouts/VaultLayout.astro";
import { getLangFromUrl, useTranslations } from "../../i18n/utils";
import { SUPPORTED_LANGS } from "@holi/configs/i18n";

export function getStaticPaths() {
  return SUPPORTED_LANGS.map((lang) => ({ params: { lang } }));
}

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const basePath = lang === "en" ? "/en" : `/${lang}`;
const strings = {
  dmWith: t("dm.with"),
  dmNotFound: t("dm.not_found"),
  dmNotSetup: t("dm.not_setup"),
  dmError: t("dm.error_title"),
  dmConnecting: t("dm.connecting"),
  openVaultFirst: t("friend.open_vault_first"),
};
---

<VaultLayout title={t("dm.title")}>
  <div class="max-w-2xl mx-auto space-y-4">
    <div class="glass-card p-4 rounded-2xl flex items-center justify-between">
      <div class="min-w-0">
        <h1 id="dm-title" class="text-xl font-bold text-white truncate">
          {t("dm.title")}
        </h1>
        <p id="dm-subtitle" class="text-xs text-zinc-500 font-mono truncate">
        </p>
      </div>
      <div class="flex items-center gap-2">
        <span
          id="dm-status"
          class="px-2 py-1 text-xs rounded-full bg-zinc-700 text-zinc-300"
          >{t("dm.connecting")}</span
        >
        <a
          href={`${basePath}/`}
          class="px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg font-medium transition-colors"
          >{t("nav.back")}</a
        >
      </div>
    </div>

    <div
      id="dm-error"
      class="hidden p-4 rounded-xl bg-red-500/10 border border-red-500/20"
    >
      <p id="dm-error-msg" class="text-sm text-red-300"></p>
      <button
        id="dm-retry-btn"
        class="mt-2 px-3 py-1 bg-red-500/20 hover:bg-red-500/30 rounded text-sm text-red-200"
      >
        {t("dm.retry")}
      </button>
    </div>

    <div
      id="dm-messages"
      class="glass-card p-4 rounded-2xl h-[55vh] overflow-auto space-y-2"
    >
    </div>

    <form id="dm-form" class="flex gap-2">
      <input
        id="dm-input"
        class="flex-1 px-4 py-2 bg-white/10 rounded-lg border border-white/10 text-white focus:border-purple-500 focus:outline-none"
        placeholder={t("dm.placeholder")}
        autocomplete="off"
      />
      <button
        type="submit"
        class="px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
      >
        {t("dm.send")}
      </button>
    </form>

    <p class="text-xs text-zinc-500">
      {t("dm.storage_info")}
    </p>
  </div>
</VaultLayout>

<style>
  .glass-card {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
  }
</style>

<script define:vars={{ strings }}>
  window.dmStrings = strings;
</script>

<script>
  import {
    getActiveHandle,
    getLastVault,
    checkAccess,
    restoreSession,
  } from "../../lib/workspace";
  import { findContactByNostrPubkey } from "../../lib/contacts/store";
  import { listDmMessages, saveDmMessage } from "../../lib/friends/dm";
  import { TrysteroDmManager } from "../../lib/friends/trystero-dm";
  import { friendsStore } from "../../lib/friends/store";
  import type { FriendDmConfig } from "../../lib/friends/p2p";
  import type { ChatEvent } from "../../lib/p2p/chat";
  import { getNostrPublicKey } from "../../lib/p2p/nostr";

  function parsePk(): string | null {
    const hash = window.location.hash.slice(1);
    const m = hash.match(/(?:^|&)pk=([0-9a-fA-F]{64})(?:$|&)/);
    return m ? m[1]!.toLowerCase() : null;
  }

  async function ensureWorkspace() {
    if (getActiveHandle()) return;
    const last = await getLastVault();
    if (!last) return;
    const status = await checkAccess(last.id);
    if (status === "granted") {
      await restoreSession(last.id);
    }
  }

  function addBubble(text: string, side: "me" | "peer") {
    const host = document.getElementById("dm-messages");
    if (!host) return;

    const row = document.createElement("div");
    row.className = `flex ${side === "me" ? "justify-end" : "justify-start"}`;

    const bubble = document.createElement("div");
    bubble.className =
      side === "me"
        ? "max-w-[80%] px-3 py-2 rounded-2xl bg-purple-600 text-white text-sm"
        : "max-w-[80%] px-3 py-2 rounded-2xl bg-white/10 text-zinc-200 text-sm";
    bubble.textContent = text;

    row.appendChild(bubble);
    host.appendChild(row);
    host.scrollTop = host.scrollHeight;
  }

  function updateStatus(state: string, message?: string) {
    const statusEl = document.getElementById("dm-status");
    const errBox = document.getElementById("dm-error");
    const errMsg = document.getElementById("dm-error-msg");
    const sendBtn = document.querySelector(
      "#dm-form button[type='submit']"
    ) as HTMLButtonElement | null;

    if (!statusEl) return;

    const stateColors: Record<string, string> = {
      idle: "bg-zinc-700 text-zinc-300",
      connecting: "bg-yellow-500/20 text-yellow-300",
      connected: "bg-green-500/20 text-green-300",
      reconnecting: "bg-orange-500/20 text-orange-300",
      error: "bg-red-500/20 text-red-300",
    };

    statusEl.className = `px-2 py-1 text-xs rounded-full ${stateColors[state] || stateColors.idle}`;
    statusEl.textContent = message || state;

    if (state === "error") {
      errBox?.classList.remove("hidden");
      if (errMsg) errMsg.textContent = message || "Connection error";
    } else {
      errBox?.classList.add("hidden");
    }

    if (sendBtn) {
      sendBtn.disabled = state !== "connected";
    }
  }

  let dmManager: TrysteroDmManager | null = null;

  async function run() {
    // These should be set via define:vars if they are translated
    const strings = (window as any).dmStrings || {
      dmWith: "DM with",
      dmNotFound: "Friend not found in this vault.",
      dmNotSetup: "DM not set up for this friend yet.",
      openVaultFirst: "Open your vault first",
    };

    const titleEl = document.getElementById("dm-title");
    const subtitleEl = document.getElementById("dm-subtitle");
    const retryBtn = document.getElementById("dm-retry-btn");

    try {
      await ensureWorkspace();
      if (!getActiveHandle()) throw new Error(strings.openVaultFirst);

      const pk = parsePk();
      if (!pk)
        throw new Error("Missing pk in URL hash. Expected /dm#pk=<64-hex>.");

      const contact = await findContactByNostrPubkey(pk);
      if (!contact) throw new Error(strings.dmNotFound);

      if (titleEl) titleEl.textContent = `${strings.dmWith} ${contact.alias}`;
      if (subtitleEl) subtitleEl.textContent = pk;

      const dm = (contact as any).dm;
      if (!dm?.sessionId || !dm?.keyB64Url) {
        throw new Error(strings.dmNotSetup);
      }

      function startDm(config: FriendDmConfig) {
        if (dmManager) return;
        dmManager = new TrysteroDmManager(config);
        dmManager.on(async (event) => {
          if (event.type === "status_change") {
            updateStatus(event.state, event.message);
          } else if (event.type === "message") {
            const msg: any = event.message;
            const content = msg.content || "";
            if (msg.senderId === "me") return;
            addBubble(content, "peer");
            await saveDmMessage(dm.sessionId, {
              id: msg.id || crypto.randomUUID(),
              ts: msg.timestamp || Date.now(),
              from: "peer",
              text: content,
              peerPubkey: pk || undefined,
            });
          } else if (event.type === "file_received") {
            addBubble(`ðŸ“ Received file: ${event.fileName}`, "peer");
            const url = URL.createObjectURL(event.blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = event.fileName;
            a.click();
          }
        });
        dmManager.start();
      }

      retryBtn?.addEventListener("click", () => {
        if (dmManager) {
          (dmManager as TrysteroDmManager).destroy();
          dmManager = null;
        }
        startDm({ ...dm, friendPubkey: pk });
      });

      const history = await listDmMessages(dm.sessionId);
      for (const m of history) {
        addBubble(m.text, m.from === "me" ? "me" : "peer");
      }

      startDm({ ...dm, friendPubkey: pk });

      const form = document.getElementById("dm-form");
      const input = document.getElementById(
        "dm-input"
      ) as HTMLInputElement | null;
      form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const text = (input?.value || "").trim();
        if (!text) return;
        if (input) input.value = "";
        if (!dmManager || dmManager.state !== "connected") return;

        addBubble(text, "me");
        (dmManager as TrysteroDmManager).sendText(text);
        await saveDmMessage(dm.sessionId, {
          id: crypto.randomUUID(),
          ts: Date.now(),
          from: "me",
          text,
        });
      });
    } catch (e) {
      updateStatus("error", (e as Error)?.message || String(e));
    }
  }

  run();

  function cleanup() {
    if (dmManager) {
      (dmManager as TrysteroDmManager).destroy();
      dmManager = null;
    }
  }
  document.addEventListener("astro:before-swap", cleanup);
  window.addEventListener("pagehide", cleanup);
  window.addEventListener("beforeunload", cleanup);
</script>
