---
import VaultLayout from "../layouts/VaultLayout.astro";

const lang = Astro.currentLocale || "en";
const basePath = lang === "en" ? "" : `/${lang}`;
---

<VaultLayout title="Add Friend">
  <div class="max-w-xl mx-auto space-y-8 text-center">
    <div id="loading" class="py-12">
      <div class="animate-spin w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full mx-auto mb-4"></div>
      <p class="text-zinc-400">Processing friend invite…</p>
    </div>

    <div id="success" class="hidden space-y-4">
      <div class="p-4 rounded-full bg-green-500/10 text-green-400 inline-block">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
      </div>
      <h1 class="text-3xl font-bold text-white">Friend request sent</h1>
      <p id="success-msg" class="text-zinc-400">Waiting for them to accept…</p>
      <a href={`${basePath}/`} class="inline-block px-6 py-2 bg-white/10 hover:bg-white/20 rounded-lg font-medium transition-colors">Back to Dashboard</a>
    </div>

    <div id="error" class="hidden space-y-4">
      <div class="p-4 rounded-full bg-red-500/10 text-red-400 inline-block">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
      </div>
      <h1 class="text-3xl font-bold text-white">Couldn’t add friend</h1>
      <p id="error-msg" class="text-zinc-400">Invite link invalid or expired.</p>
      <div class="flex flex-col sm:flex-row gap-3 justify-center">
        <button
          id="open-vault-btn"
          type="button"
          class="px-6 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg font-medium transition-colors"
        >
          Open Local Folder
        </button>
        <a href={`${basePath}/`} class="inline-block px-6 py-2 bg-white/10 hover:bg-white/20 rounded-lg font-medium transition-colors">Back to Dashboard</a>
      </div>
    </div>
  </div>
</VaultLayout>

<script>
  import { parseFriendInviteHash, sendFriendRequestAndWaitAccept } from "../lib/friends/invite";
  import { addContactWithNostrPubkey, setContactDmByNostrPubkey } from "../lib/contacts/store";
  import { getPrimaryIdentity } from "../lib/identity/manager";
  import { getLastVault, checkAccess, restoreSession, getActiveHandle, openWorkspace } from "../lib/workspace";

  async function ensureWorkspace() {
    if (getActiveHandle()) return;
    const last = await getLastVault();
    if (last) {
      const status = await checkAccess(last.id);
      if (status === "granted") {
        await restoreSession(last.id);
        return;
      }
    }
  }

  async function run() {
    const loadingEl = document.getElementById('loading');
    const successEl = document.getElementById('success');
    const errorEl = document.getElementById('error');
    const successMsg = document.getElementById('success-msg');
    const errorMsg = document.getElementById('error-msg');

    try {
      await ensureWorkspace();
      if (!getActiveHandle()) {
        throw new Error('Open a local folder first to save this friend into your vault.');
      }

      const hash = window.location.hash.slice(1);
      const invite = parseFriendInviteHash(hash);
      if (!invite) throw new Error('Invalid invite link');

      loadingEl?.classList.add('hidden');
      successEl?.classList.remove('hidden');

      const identity = await getPrimaryIdentity();
      const name = identity?.alias || 'Anonymous';

      const { inviterPubkey, inviterName, dm } = await sendFriendRequestAndWaitAccept({
        sessionId: invite.sessionId,
        secretKey32: invite.secretKey32,
        name,
      });

      await addContactWithNostrPubkey(inviterName, inviterPubkey);
      if (dm) {
        await setContactDmByNostrPubkey(inviterPubkey, dm);
      }
      if (successMsg) successMsg.textContent = `You’re now connected with ${inviterName}.`; 
    } catch (e) {
      console.error('[Friend] Failed:', e);
      loadingEl?.classList.add('hidden');
      successEl?.classList.add('hidden');
      errorEl?.classList.remove('hidden');
      if (errorMsg) errorMsg.textContent = (e as Error)?.message || String(e);
    }
  }

  document.getElementById('open-vault-btn')?.addEventListener('click', async () => {
    try {
      await openWorkspace();
      await run();
    } catch (e) {
      console.error('[Friend] Failed to open workspace:', e);
    }
  });

  run();
</script>
