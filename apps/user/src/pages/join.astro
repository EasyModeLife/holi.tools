---
/**
 * Legacy Join Page
 *
 * Holi has migrated project collaboration to Trystero-based Vault links:
 *   /vault#<projectId>.<secret>
 *
 * This route is kept for backward compatibility. If the hash looks like a
 * vault invite, we redirect. If it looks like a legacy ns= invite, we show a
 * clear error telling the user to request a new Instant Link.
 */
import VaultLayout from "../layouts/VaultLayout.astro";

const lang = Astro.currentLocale || "en";
const basePath = lang === "en" ? "" : `/${lang}`;
---

<VaultLayout title="Join Project">
  <div class="max-w-xl mx-auto space-y-6 text-center">
    <div id="loading" class="py-12 space-y-3">
      <div class="animate-spin w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full mx-auto"></div>
      <p class="text-zinc-400">Checking inviteâ€¦</p>
    </div>

    <div id="message" class="hidden space-y-4">
      <h1 class="text-3xl font-bold text-white">Join Project</h1>
      <p id="message-text" class="text-zinc-400"></p>
      <div class="flex justify-center gap-3">
        <a
          href={`${basePath}/`}
          class="inline-block px-6 py-2 bg-white/10 hover:bg-white/20 rounded-lg font-medium transition-colors"
        >
          Home
        </a>
        <a
          href={`${basePath}/vault`}
          class="inline-block px-6 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg font-medium transition-colors"
        >
          Open Vault
        </a>
      </div>
    </div>
  </div>

  <script define:vars={{ basePath }}>
    function showMessage(text) {
      document.getElementById("loading")?.classList.add("hidden");
      const msg = document.getElementById("message");
      if (msg) msg.classList.remove("hidden");
      const textEl = document.getElementById("message-text");
      if (textEl) textEl.textContent = text;
    }

    function normalize(raw) {
      const trimmed = (raw || "").trim().replace(/^#/, "");
      if (!trimmed) return "";
      if (trimmed.startsWith("vault#")) return trimmed.slice("vault#".length);
      return trimmed;
    }

    const rawHash = decodeURIComponent(window.location.hash || "").slice(1);
    const token = normalize(rawHash);

    // New format: <projectId>.<secret>
    if (token.includes(".") && !token.startsWith("ns=")) {
      window.location.replace(`${basePath}/vault#${token}`);
    } else if (token.startsWith("ns=")) {
      showMessage(
        "This is a legacy invite format. Ask the project owner for a new Instant Link (from the Vault page) like: /vault#<projectId>.<secret>."
      );
    } else {
      showMessage(
        "Invite links have moved. Use a Vault Instant Link like: /vault#<projectId>.<secret>."
      );
    }
  </script>
</VaultLayout>
