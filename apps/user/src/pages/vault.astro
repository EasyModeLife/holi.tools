---
/**
 * Project Detail Page - Shows project info and sharing options
 * Uses URL hash for project ID since we're in static mode
 */
import VaultLayout from "../layouts/VaultLayout.astro";
import ChatPanel from "../components/ChatPanel.astro";
import StoragePanel from "../components/StoragePanel.astro";

const lang = Astro.currentLocale || "en";
const basePath = lang === "en" ? "" : `/${lang}`;
---

<VaultLayout title="Project Vault">
  <div class="max-w-4xl mx-auto space-y-8">
    <!-- Header -->
    <div class="flex items-center gap-4">
      <a href={`${basePath}/`} class="p-2 hover:bg-white/10 rounded-lg transition-colors">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"><path d="m15 18-6-6 6-6"></path></svg
        >
      </a>
      <div>
        <h1 id="project-name" class="text-2xl font-bold text-white">
          Loading...
        </h1>
        <p id="project-role" class="text-sm text-zinc-400"></p>
      </div>
    </div>

    <!-- Actions -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Share Card -->
      <div class="glass-card p-6 rounded-xl space-y-4">
        <div class="flex items-center gap-3">
          <div class="p-2 bg-purple-500/20 rounded-lg text-purple-400">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              ><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"
              ></path><polyline points="16 6 12 2 8 6"></polyline><line
                x1="12"
                y1="2"
                x2="12"
                y2="15"></line></svg
            >
          </div>
          <h2 class="text-lg font-semibold text-white">Share Project</h2>
        </div>
        <p class="text-sm text-zinc-400">
          Generate a secure invitation link to share this project with a
          collaborator.
        </p>
        <button
          id="instant-link-btn"
          class="w-full py-2 bg-purple-600 hover:bg-purple-500 rounded-lg font-medium transition-colors"
        >
          Copy Instant Link (Owner)
        </button>
      </div>

      <!-- Peers Card -->
      <div class="glass-card p-6 rounded-xl space-y-4">
        <div class="flex items-center gap-3">
          <div class="p-2 bg-blue-500/20 rounded-lg text-blue-400">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              ><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"
              ></path><circle cx="9" cy="7" r="4"></circle><path
                d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path
                d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg
            >
          </div>
          <h2 class="text-lg font-semibold text-white">Connected Peers</h2>
        </div>
        <div id="peers-list" class="text-sm text-zinc-400">
          <p>No peers connected yet.</p>
        </div>
      </div>
    </div>

    <!-- Project Chat -->
    <div class="glass-card p-6 rounded-xl space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-white">Project Chat</h2>
        <p class="text-xs text-zinc-500">Messages persist per project</p>
      </div>
      <div id="chat-container">
        <ChatPanel connected={false} embedded={true} />
      </div>
    </div>

    <!-- Storage Panel -->
    <div class="mt-8">
      <StoragePanel />
    </div>
  </div>

  <!-- Locked Vault Overlay -->
  <div
    id="locked-overlay"
    class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4"
  >
    <div class="glass-card max-w-md w-full p-8 text-center space-y-6">
      <div
        class="mx-auto w-16 h-16 bg-yellow-500/20 text-yellow-400 rounded-full flex items-center justify-center"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="32"
          height="32"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          ><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path
            d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg
        >
      </div>
      <div>
        <h2 class="text-2xl font-bold text-white mb-2">Vault Locked</h2>
        <p class="text-zinc-400">
          Security check required to access your local project files.
        </p>
      </div>
      <button
        id="unlock-btn"
        class="w-full py-3 bg-yellow-600 hover:bg-yellow-500 text-white rounded-lg font-bold transition-colors"
      >
        Unlock Vault
      </button>
      <a href="/" class="block text-sm text-zinc-500 hover:text-white mt-4"
        >Return to Dashboard</a
      >
    </div>
  </div>
</VaultLayout>

<style>
  .glass-card {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
  }
</style>

<script>
  import { VaultController } from "../lib/vault/controller";

  // Initialize Controller
  const controller = new VaultController();

  // Start immediately
  controller.init();

  // Cleanup on navigation
  function cleanup() {
    controller.cleanup();
  }

  document.addEventListener("astro:before-swap", cleanup);
  window.addEventListener("pagehide", cleanup);
  window.addEventListener("beforeunload", cleanup);
</script>
