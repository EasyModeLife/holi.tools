---
/**
 * StoragePanel - File manager for local folder storage
 * Shows files stored in the project's local folder
 */
---

<div
  id="storage-panel"
  class="glass-card p-6 rounded-2xl border border-white/10 relative overflow-hidden"
>
  <div
    class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-purple-500 to-pink-500 opacity-30"
  >
  </div>

  <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      class="text-purple-400"
      ><path
        d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"
      ></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line
        x1="12"
        y1="22.08"
        x2="12"
        y2="12"></line></svg
    >
    Project Files
  </h2>

  <!-- Upload into project/ -->
  <div class="mb-5 p-4 rounded-xl bg-white/5 border border-white/10">
    <div class="flex items-center justify-between gap-3">
      <div class="min-w-0">
        <div class="text-sm font-semibold text-white">Upload to project/</div>
        <div class="text-xs text-zinc-500">Stores in the shared project folder tree (not chat/).</div>
      </div>
      <button
        id="open-project-folder"
        type="button"
        class="text-xs text-purple-400 hover:text-purple-300"
      >
        Open project folder
      </button>
    </div>

    <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
      <div class="space-y-1">
        <label class="text-[11px] text-zinc-500">Subfolder (inside project/)</label>
        <input
          id="project-upload-folder"
          type="text"
          placeholder="e.g. specs, assets/images"
          class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-sm text-white placeholder:text-zinc-500 focus:outline-none focus:ring-2 focus:ring-purple-500/40"
        />
      </div>
      <div class="space-y-1">
        <label class="text-[11px] text-zinc-500">Files</label>
        <input
          id="project-upload-input"
          type="file"
          multiple
          class="block w-full text-sm text-zinc-300 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-white/10 file:text-zinc-200 hover:file:bg-white/15"
        />
        <label class="flex items-center gap-2 text-xs text-zinc-400 select-none">
          <input id="project-upload-announce" type="checkbox" class="accent-purple-500" checked />
          Post to chat
        </label>
      </div>
    </div>

    <div class="mt-3 flex items-center justify-end">
      <button
        id="project-upload-btn"
        type="button"
        class="px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg font-medium transition-colors text-sm"
      >
        Upload
      </button>
    </div>
  </div>

  <!-- No Workspace Warning -->
  <div
    id="no-workspace-warning"
    class="hidden p-4 rounded-xl bg-yellow-500/10 border border-yellow-500/20 mb-4"
  >
    <p class="text-sm text-yellow-400">
      ⚠️ No local folder selected. Files cannot be saved.
    </p>
    <p class="text-xs text-zinc-500 mt-1">
      Go to Dashboard and click "Open Local Folder" to enable file storage.
    </p>
  </div>

  <!-- File List -->
  <div class="space-y-4">
    <div class="flex items-center justify-between">
      <h3 class="text-sm font-semibold text-white">Stored Files</h3>
      <button
        id="refresh-files-btn"
        class="text-xs text-purple-400 hover:text-purple-300 flex items-center gap-1"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="12"
          height="12"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          ><path
            d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"
          ></path></svg
        >
        Refresh
      </button>
    </div>

    <div id="file-breadcrumb" class="text-xs text-zinc-400 flex items-center gap-2">
      <button id="breadcrumb-root" class="text-purple-400 hover:underline">root</button>
      <span id="breadcrumb-path" class="truncate"></span>
    </div>
    <div id="file-list" class="space-y-2 max-h-60 overflow-y-auto pr-2">
      <p class="text-xs text-zinc-500 italic">Loading...</p>
    </div>
  </div>
</div>

<!-- File Preview Dialog -->
<dialog
  id="file-preview-dialog"
  class="backdrop:bg-black/70 rounded-xl p-0 w-[min(92vw,48rem)]"
>
  <div class="glass-card border border-white/10 rounded-xl overflow-hidden">
    <div class="flex items-center justify-between p-4 border-b border-white/10">
      <div class="min-w-0">
        <div class="text-sm text-zinc-400">Preview</div>
        <div id="file-preview-name" class="text-white font-semibold truncate"></div>
      </div>
      <button
        id="file-preview-close"
        class="px-3 py-1.5 bg-white/10 hover:bg-white/20 rounded-lg text-sm"
      >
        Close
      </button>
    </div>
    <div class="p-4 space-y-3">
      <div id="file-preview-body" class="min-h-24"></div>
      <div class="flex items-center justify-end gap-2 pt-2 border-t border-white/10">
        <button
          id="file-preview-download"
          class="px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg font-medium transition-colors text-sm"
        >
          Download
        </button>
      </div>
    </div>
  </div>
</dialog>

<script>
  import * as fsdb from "../lib/db/fs";
  import { getActiveHandle } from "../lib/workspace";

  const fileList = document.getElementById("file-list");
  const refreshFilesBtn = document.getElementById("refresh-files-btn");
  const noWorkspaceWarning = document.getElementById("no-workspace-warning");
  const breadcrumbRoot = document.getElementById('breadcrumb-root') as HTMLButtonElement | null;
  const breadcrumbPath = document.getElementById('breadcrumb-path');

  const projectUploadFolder = document.getElementById('project-upload-folder') as HTMLInputElement | null;
  const projectUploadInput = document.getElementById('project-upload-input') as HTMLInputElement | null;
  const projectUploadAnnounce = document.getElementById('project-upload-announce') as HTMLInputElement | null;
  const projectUploadBtn = document.getElementById('project-upload-btn') as HTMLButtonElement | null;
  const openProjectFolderBtn = document.getElementById('open-project-folder') as HTMLButtonElement | null;

  let currentFolder = '';

  const previewDialog = document.getElementById(
    "file-preview-dialog"
  ) as HTMLDialogElement | null;
  const previewName = document.getElementById("file-preview-name");
  const previewBody = document.getElementById("file-preview-body");
  const previewClose = document.getElementById("file-preview-close");
  const previewDownload = document.getElementById(
    "file-preview-download"
  ) as HTMLButtonElement | null;

  let currentPreview: { url: string; blob: Blob; filename: string } | null = null;

  function revokeCurrentPreview() {
    if (currentPreview?.url) {
      try {
        URL.revokeObjectURL(currentPreview.url);
      } catch {
        // ignore
      }
    }
    currentPreview = null;
  }

  async function openPreview(projectId: string, filename: string) {
    if (!previewDialog || !previewBody || !previewName || !previewDownload) return;

    if (!getActiveHandle()) {
      alert("Open your Vault folder to preview files.");
      return;
    }

    previewName.textContent = filename;
    previewBody.innerHTML = '<p class="text-sm text-zinc-400">Loading preview…</p>';
    previewDialog.showModal();

    try {
      revokeCurrentPreview();
      const blob = await fsdb.readProjectFile(projectId, filename);
      const url = URL.createObjectURL(blob);
      currentPreview = { url, blob, filename };

      const type = blob.type || '';
      const lower = filename.toLowerCase();
      const isImage = type.startsWith('image/') || /\.(png|jpe?g|gif|webp|bmp|svg)$/.test(lower);

      if (isImage) {
        previewBody.innerHTML = `
          <div class="rounded-lg border border-white/10 bg-black/30 p-2">
            <img src="${url}" alt="${filename}" class="max-h-[60vh] w-full object-contain rounded" />
          </div>
        `;
      } else if (type.startsWith('text/') || /\.(txt|md|json|log|csv)$/.test(lower)) {
        const text = await blob.text();
        const snippet = text.length > 30_000 ? text.slice(0, 30_000) + "\n…" : text;
        previewBody.innerHTML = `
          <pre class="text-xs text-zinc-200 whitespace-pre-wrap break-words bg-black/30 border border-white/10 rounded-lg p-3 max-h-[60vh] overflow-auto"></pre>
        `;
        const pre = previewBody.querySelector('pre');
        if (pre) (pre as HTMLElement).textContent = snippet;
      } else {
        const sizeKb = Math.round(blob.size / 1024);
        previewBody.innerHTML = `
          <div class="text-sm text-zinc-300">
            <div class="font-medium">No inline preview</div>
            <div class="text-zinc-500 mt-1">Type: ${type || 'unknown'} • Size: ${sizeKb} KB</div>
            <div class="text-zinc-500 mt-1">Use Download to save/open locally.</div>
          </div>
        `;
      }

      previewDownload.onclick = async () => {
        const p = currentPreview;
        if (!p) return;
        const a = document.createElement('a');
        a.href = p.url;
        a.download = p.filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      };
    } catch (e) {
      console.error('Preview failed', e);
      previewBody.innerHTML = '<p class="text-sm text-red-400">Preview failed.</p>';
    }
  }

  function setCurrentFolder(folder: string) {
    // folder is a relative prefix without leading/trailing slash
    currentFolder = (folder || '').replace(/^\/+/, '').replace(/\/+$/, '');
    if (breadcrumbPath) breadcrumbPath.textContent = currentFolder ? `/${currentFolder}` : '';
    void refreshFiles();
  }

  previewClose?.addEventListener('click', () => {
    previewDialog?.close();
  });
  previewDialog?.addEventListener('close', () => {
    revokeCurrentPreview();
  });

  function getCurrentProjectId(): string {
    const override = (window as any).__holiActiveProjectId as string | undefined;
    if (override && typeof override === 'string' && override.trim()) return override.trim();
    const hash = window.location.hash.slice(1);
    if (!hash) return '';
    // vault links are /vault#<projectId>.<secret>
    const [projectId] = hash.split('.', 1);
    return projectId || '';
  }

  openProjectFolderBtn?.addEventListener('click', () => {
    setCurrentFolder('project');
    (window as any).holiScrollToProjectFiles?.();
  });

  projectUploadBtn?.addEventListener('click', async () => {
    const projectId = getCurrentProjectId();
    const files = projectUploadInput?.files ? Array.from(projectUploadInput.files) : [];
    const folder = (projectUploadFolder?.value || '').trim();
    const announce = Boolean(projectUploadAnnounce?.checked);

    if (!projectId) {
      alert('No project selected.');
      return;
    }

    if (files.length === 0) {
      alert('Pick one or more files to upload.');
      return;
    }

    const fn = (window as any).holiUploadProjectFiles as
      | ((files: File[], folder: string, announce: boolean) => Promise<void>)
      | undefined;

    if (!fn) {
      alert('Upload handler not ready yet. Reload the page.');
      return;
    }

    projectUploadBtn.disabled = true;
    projectUploadBtn.textContent = 'Uploading…';
    try {
      await fn(files, folder, announce);
      if (projectUploadInput) projectUploadInput.value = '';
      // Jump to where the files landed.
      setCurrentFolder(folder ? `project/${folder}` : 'project');
    } catch (e) {
      console.error('Upload failed', e);
      alert('Upload failed: ' + ((e as any)?.message || 'unknown error'));
    } finally {
      projectUploadBtn.disabled = false;
      projectUploadBtn.textContent = 'Upload';
    }
  });

  async function refreshFiles() {
    if (!fileList) return;

    const handle = getActiveHandle();

    if (!handle) {
      fileList.innerHTML =
        '<p class="text-xs text-zinc-500 italic">No workspace active.</p>';
      if (noWorkspaceWarning) noWorkspaceWarning.classList.remove("hidden");
      return;
    }

    if (noWorkspaceWarning) noWorkspaceWarning.classList.add("hidden");

    const projectId = getCurrentProjectId();
    if (!projectId) {
      fileList.innerHTML =
        '<p class="text-xs text-zinc-500 italic">No project selected.</p>';
      return;
    }

    fileList.innerHTML =
      '<p class="text-xs text-zinc-500 italic animate-pulse">Loading files...</p>';

    try {
      const allPaths = await fsdb.listProjectFiles(projectId);

      // Compute folders + files for currentFolder
      const prefix = currentFolder ? `${currentFolder}/` : '';
      const directFolders = new Set<string>();
      const directFiles: string[] = [];

      for (const p of allPaths) {
        if (prefix && !p.startsWith(prefix)) continue;
        const rest = prefix ? p.slice(prefix.length) : p;
        if (!rest) continue;
        const idx = rest.indexOf('/');
        if (idx >= 0) {
          directFolders.add(rest.slice(0, idx));
        } else {
          directFiles.push(rest);
        }
      }

      const folders = Array.from(directFolders).sort((a, b) => a.localeCompare(b));
      const files = directFiles.sort((a, b) => a.localeCompare(b));

      if (folders.length === 0 && files.length === 0) {
        fileList.innerHTML =
          '<p class="text-xs text-zinc-500 italic">No files stored yet.</p>';
        return;
      }

      fileList.innerHTML = "";

      // Folders first
      for (const folderName of folders) {
        const div = document.createElement('div');
        div.className =
          'flex items-center justify-between p-3 bg-white/5 rounded-lg border border-white/5 hover:bg-white/10 transition-colors';

        const left = document.createElement('div');
        left.className = 'flex items-center gap-2 min-w-0';
        left.innerHTML =
          '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>';

        const nameSpan = document.createElement('span');
        nameSpan.className = 'text-sm text-zinc-200 truncate cursor-pointer';
        nameSpan.textContent = folderName;
        nameSpan.title = 'Open folder';
        nameSpan.onclick = () => setCurrentFolder(currentFolder ? `${currentFolder}/${folderName}` : folderName);

        left.appendChild(nameSpan);

        const openBtn = document.createElement('button');
        openBtn.className = 'text-zinc-400 hover:text-white p-1.5 rounded hover:bg-white/10';
        openBtn.title = 'Open';
        openBtn.innerHTML =
          '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>';
        openBtn.onclick = () => setCurrentFolder(currentFolder ? `${currentFolder}/${folderName}` : folderName);

        div.appendChild(left);
        div.appendChild(openBtn);
        fileList.appendChild(div);
      }

      for (const filename of files) {
        const fullPath = prefix ? `${prefix}${filename}` : filename;
        const div = document.createElement("div");
        div.className =
          "flex items-center justify-between p-3 bg-white/5 rounded-lg border border-white/5 hover:bg-white/10 transition-colors";

        const nameSpan = document.createElement("span");
        nameSpan.className = "text-sm text-zinc-300 truncate max-w-[200px]";
        nameSpan.textContent = filename;

        const actions = document.createElement('div');
        actions.className = 'flex items-center gap-1';

        const previewBtn = document.createElement('button');
        previewBtn.innerHTML =
          '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12Z"></path><circle cx="12" cy="12" r="3"></circle></svg>';
        previewBtn.className =
          'text-zinc-400 hover:text-white p-1.5 rounded hover:bg-white/10';
        previewBtn.title = 'Preview';
        previewBtn.onclick = () => openPreview(projectId, fullPath);

        const downloadBtn = document.createElement("button");
        downloadBtn.innerHTML =
          '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>';
        downloadBtn.className =
          "text-zinc-400 hover:text-white p-1.5 rounded hover:bg-white/10";
        downloadBtn.title = "Download";

        downloadBtn.onclick = async () => {
          try {
            const blob = await fsdb.readProjectFile(projectId, fullPath);
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          } catch (e) {
            console.error("Download failed", e);
            alert("Download failed: " + (e as Error).message);
          }
        };

        nameSpan.role = 'button';
        nameSpan.title = 'Preview';
        nameSpan.classList.add('cursor-pointer');
        nameSpan.onclick = () => openPreview(projectId, fullPath);

        actions.appendChild(previewBtn);
        actions.appendChild(downloadBtn);

        div.appendChild(nameSpan);
        div.appendChild(actions);
        fileList.appendChild(div);
      }
    } catch (e) {
      console.error("Failed to list files:", e);
      fileList.innerHTML =
        '<p class="text-xs text-red-400">Error loading files.</p>';
    }
  }

  // Expose refresh to window so Chat can trigger it
  (window as any).refreshStorageFiles = refreshFiles;

  // Expose preview so Vault chat can open it.
  (window as any).holiPreviewProjectFile = (projectId: string, filename: string) =>
    openPreview(projectId, filename);

  (window as any).holiScrollToProjectFiles = () => {
    document.getElementById('storage-panel')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
  };

  (window as any).holiSetProjectFilesFolder = (folder: string) => setCurrentFolder(folder);

  breadcrumbRoot?.addEventListener('click', (e) => {
    e.preventDefault();
    setCurrentFolder('');
  });

  refreshFilesBtn?.addEventListener("click", refreshFiles);

  // Listen for workspace restoration from vault.astro
  window.addEventListener("workspace-restored", () => {
    console.log("[StoragePanel] Workspace restored, refreshing files...");
    refreshFiles();
  });

  // Initialize with slight delay to allow vault.astro to restore workspace first
  setTimeout(refreshFiles, 100);
</script>
