---
interface Props {
  connected?: boolean;
  embedded?: boolean;
}

const { connected = false, embedded = false } = Astro.props;
---

<div
  id="chat-panel"
  class={`${embedded ? "w-full h-[520px]" : "fixed bottom-4 right-4 w-80 max-h-[500px]"} flex flex-col bg-zinc-900/95 border border-white/10 rounded-2xl shadow-2xl backdrop-blur-xl overflow-hidden transition-all duration-300`}
>
  <!-- Header -->
  <div
    class="px-4 py-3 border-b border-white/10 flex justify-between items-center bg-gradient-to-r from-purple-600/20 to-transparent"
  >
    <div class="flex items-center gap-3">
      <div
        id="status-dot"
        class={`w-2 h-2 rounded-full ${connected ? "bg-green-400" : "bg-yellow-500 animate-pulse"}`}
      >
      </div>
      <span class="font-semibold text-sm text-white" id="chat-status">
        {connected ? "Connected" : "Awaiting Connection"}
      </span>
      <span
        id="encryption-status"
        class="hidden px-2 py-0.5 rounded-full text-[11px] font-medium border"
      ></span>
    </div>
    <div class="flex items-center gap-1">
      <button
        id="retry-connection-btn"
        type="button"
        class="px-2 py-1 text-[11px] text-zinc-200 bg-white/10 hover:bg-white/20 rounded-md transition-all"
        title="Retry connection"
      >
        Retry
      </button>

      <button
        id="minimize-btn"
        type="button"
        class="p-1 text-zinc-400 hover:text-white hover:bg-white/10 rounded-lg transition-all"
        title="Minimize"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          ><line x1="5" y1="12" x2="19" y2="12"></line></svg
        >
      </button>
    </div>
  </div>

  <!-- Messages Area -->
  <div
    id="messages-list"
    class="flex flex-col flex-1 overflow-y-auto p-3 space-y-2 min-h-[200px] max-h-[350px] scrollbar-thin"
  >
    <div class="text-center py-8 text-zinc-500">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="32"
        height="32"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="mx-auto mb-2 opacity-50"
        ><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
        ></path></svg
      >
      <p class="text-xs">Messages will appear here</p>
    </div>
  </div>

  <!-- File Transfer Progress (hidden by default) -->
  <div id="file-progress-bar" class="hidden px-4 py-2 bg-black/30">
    <div class="flex items-center gap-2 text-xs text-zinc-300">
      <svg
        class="animate-spin"
        xmlns="http://www.w3.org/2000/svg"
        width="14"
        height="14"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        ><circle
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-opacity="0.25"></circle><path
          d="M12 2a10 10 0 0 1 10 10"
          stroke="currentColor"></path></svg
      >
      <span id="progress-text">Transferring...</span>
    </div>
    <div class="mt-1 h-1 bg-white/10 rounded-full overflow-hidden">
      <div
        id="progress-fill"
        class="h-full bg-purple-500 transition-all duration-200"
        style="width: 0%"
      >
      </div>
    </div>
  </div>

  <!-- Drop Zone Overlay -->
  <div
    id="drop-overlay"
    class="absolute inset-0 bg-purple-600/90 backdrop-blur-sm rounded-2xl flex flex-col items-center justify-center hidden z-50"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="40"
      height="40"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      class="text-white mb-2"
      ><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline
        points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"
      ></line></svg
    >
    <span class="text-white font-semibold">Drop to Send</span>
  </div>

  <!-- Input Area -->
  <div class="p-2 border-t border-white/10 bg-black/20">
    <form id="chat-form" class="flex gap-2 items-center">
      <label
        class="p-2 text-zinc-400 hover:text-purple-400 hover:bg-white/5 rounded-lg cursor-pointer transition-all"
        title="Attach File"
      >
        <input type="file" id="file-input" class="hidden" />
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          ><path
            d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"
          ></path></svg
        >
      </label>
      <input
        type="text"
        id="msg-input"
        class="flex-1 bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm text-white placeholder-zinc-500 focus:outline-none focus:border-purple-500/50 focus:bg-white/10 transition-all"
        placeholder="Message..."
        autocomplete="off"
      />
      <button
        type="submit"
        class="bg-purple-600 hover:bg-purple-500 active:scale-95 text-white p-2 rounded-lg transition-all"
        title="Send"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          ><line x1="22" y1="2" x2="11" y2="13"></line><polygon
            points="22 2 15 22 11 13 2 9 22 2"></polygon></svg
        >
      </button>
    </form>
  </div>
</div>

<style is:global>
  .scrollbar-thin::-webkit-scrollbar {
    width: 4px;
  }
  .scrollbar-thin::-webkit-scrollbar-track {
    background: transparent;
  }
  .scrollbar-thin::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 999px;
  }

  /* Message Bubbles - Scoped to chat panel manually */
  #chat-panel .msg {
    max-width: 85%;
    padding: 0.5rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.8125rem;
    line-height: 1.4;
    word-break: break-word;
  }

  #chat-panel .msg-own {
    background: linear-gradient(135deg, #9333ea, #7c3aed);
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 0.25rem;
    margin-left: auto;
  }

  #chat-panel .msg-peer {
    background: rgba(255, 255, 255, 0.08);
    color: #e4e4e7;
    align-self: flex-start;
    border-bottom-left-radius: 0.25rem;
    border: 1px solid rgba(255, 255, 255, 0.05);
    margin-right: auto;
  }

  #chat-panel .msg-system {
    max-width: 100%;
    align-self: center;
    font-size: 0.7rem;
    color: #a1a1aa;
    background: rgba(255, 255, 255, 0.03);
    padding: 0.375rem 0.75rem;
    border-radius: 0.5rem;
    text-align: center;
    margin-left: auto;
    margin-right: auto;
  }

  #chat-panel .msg-file {
    background: rgba(147, 51, 234, 0.15);
    border: 1px solid rgba(147, 51, 234, 0.3);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  #chat-panel .msg-file svg {
    flex-shrink: 0;
  }
</style>

<script>
  // UI Logic
  const messagesList = document.getElementById("messages-list")!;
  const progressBar = document.getElementById("file-progress-bar")!;
  const progressFill = document.getElementById("progress-fill")!;
  const progressText = document.getElementById("progress-text")!;
  const encryptionStatus = document.getElementById("encryption-status");

  let hasMessages = false;

  // Safety: never let the chat form submit navigate/reload.
  // Pages can attach their own submit handler for sending.
  document.getElementById("chat-form")?.addEventListener("submit", (e) => {
    e.preventDefault();
  });

  // Public: Add chat message
  (window as any).addChatMessage = (
    text: any,
    type: "own" | "peer" | "system" = "system",
    colorStyle: string = "",
    senderName: string = "",
    avatarUrl: string = "" // [New] Avatar URL
  ) => {
    const safeText = typeof text === "string" ? text : String(text ?? "");

    // Clear placeholder on first message
    if (!hasMessages) {
      messagesList.innerHTML = "";
      hasMessages = true;
    }

    const el = document.createElement("div");
    el.className = `msg msg-${type}`;

    // Apply styling for peers
    if (type === "peer" && colorStyle) {
      el.style.borderLeft = `3px solid ${colorStyle}`;
    }

    let contentHtml = "";

    // Header for peer
    if (type === "peer" && senderName) {
      const avatarHtml = avatarUrl
        ? `<div class="w-4 h-4 rounded-full bg-cover bg-center shrink-0" style="background-image: url(${avatarUrl})"></div>`
        : ``;

      contentHtml += `
        <div class="flex items-center gap-1.5 mb-1 opacity-70">
            ${avatarHtml}
            <span class="text-[10px] font-bold" style="color: ${colorStyle}">${senderName}</span>
        </div>`;
    }

    // Check if it's a file message or HTML link
    if (
      safeText.includes("Receiving") ||
      safeText.includes("Sent") ||
      safeText.includes("Sending") ||
      safeText.includes("<a ") ||
      safeText.includes("<button") ||
      safeText.includes("data-holi-action=")
    ) {
      // If it contains HTML tag, treat as HTML
      if (
        safeText.includes("<a ") ||
        safeText.includes("<button") ||
        safeText.includes("data-holi-action=")
      ) {
        el.innerHTML = safeText; // Trusted content from Controller
      } else {
        el.classList.add("msg-file");
        contentHtml += `
            <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
            <span>${safeText}</span>
            </div>
          `;
        el.innerHTML = contentHtml;
      }
    } else {
      el.innerHTML =
        contentHtml + `<div class="whitespace-pre-wrap">${safeText}</div>`;
    }

    messagesList.appendChild(el);
    messagesList.scrollTop = messagesList.scrollHeight;
  };

  // Public: Show file progress
  (window as any).showFileProgress = (progress: number, filename: string) => {
    progressBar.classList.remove("hidden");
    progressFill.style.width = `${Math.min(100, progress * 100)}%`;
    progressText.textContent = `${filename} - ${Math.round(progress * 100)}%`;

    if (progress >= 1) {
      setTimeout(() => {
        progressBar.classList.add("hidden");
        progressFill.style.width = "0%";
      }, 1000);
    }
  };

  // Public: Set encryption badge
  (window as any).setChatEncryptionStatus = (enabled: boolean) => {
    if (!encryptionStatus) return;
    encryptionStatus.classList.remove(
      "hidden",
      "bg-emerald-500/10",
      "text-emerald-300",
      "border-emerald-500/20",
      "bg-zinc-500/10",
      "text-zinc-300",
      "border-white/10"
    );

    if (enabled) {
      encryptionStatus.classList.add(
        "bg-emerald-500/10",
        "text-emerald-300",
        "border-emerald-500/20"
      );
      encryptionStatus.textContent = "Encrypted";
    } else {
      encryptionStatus.classList.add(
        "bg-zinc-500/10",
        "text-zinc-300",
        "border-white/10"
      );
      encryptionStatus.textContent = "Plaintext";
    }
  };

  // Drag and Drop
  const panel = document.getElementById("chat-panel")!;
  const dropOverlay = document.getElementById("drop-overlay")!;
  let dragCounter = 0;

  panel.addEventListener("dragenter", (e) => {
    e.preventDefault();
    dragCounter++;
    dropOverlay.classList.remove("hidden");
  });

  panel.addEventListener("dragleave", (e) => {
    e.preventDefault();
    dragCounter--;
    if (dragCounter === 0) dropOverlay.classList.add("hidden");
  });

  panel.addEventListener("dragover", (e) => e.preventDefault());

  panel.addEventListener("drop", (e) => {
    e.preventDefault();
    e.stopPropagation();
    dropOverlay.classList.add("hidden");
    dragCounter = 0;

    const files = e.dataTransfer?.files;
    if (files && files.length > 0) {
      panel.dispatchEvent(
        new CustomEvent("file-drop", {
          detail: { file: files[0] },
          bubbles: true,
          composed: true,
        })
      );
    }
  });

  document.getElementById("file-input")?.addEventListener("change", (e) => {
    const file = (e.target as HTMLInputElement).files?.[0];
    if (file) {
      panel.dispatchEvent(
        new CustomEvent("file-drop", {
          detail: { file },
          bubbles: true,
          composed: true,
        })
      );
    }
  });

  // Minimize toggle
  document.getElementById("minimize-btn")?.addEventListener("click", () => {
    const msgList = document.getElementById("messages-list")!;
    const inputArea = panel.querySelector("form")?.parentElement!;

    if (msgList.classList.contains("hidden")) {
      msgList.classList.remove("hidden");
      inputArea.classList.remove("hidden");
      panel.classList.remove("max-h-12");
    } else {
      msgList.classList.add("hidden");
      inputArea.classList.add("hidden");
      panel.classList.add("max-h-12");
    }
  });
</script>
