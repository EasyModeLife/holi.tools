---
import { getLangFromUrl, useTranslations } from "../../i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const strings = {
  loading: t("vault.loading"),
  guest: t("vault.guest"),
  permissionNeeded: t("vault.permission_needed"),
  status: t("vault.status"),
  status_label: t("vault.status_label"),
  open_folder: t("vault.open_folder"),
  edit_profile: t("vault.edit_profile"),
  switch_vault: t("vault.switch_vault"),
};
---

<header
  class="bg-white/5 border-b border-white/5 p-6 flex flex-col md:flex-row items-start md:items-center justify-between gap-4"
>
  <!-- Vault Info -->
  <div class="flex items-center gap-4">
    <div class="p-3 bg-blue-500/20 text-blue-400 rounded-xl">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="lucide lucide-folder-open"
        ><path
          d="m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.55 6a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H20a2 2 0 0 1 2 2v2"
        ></path></svg
      >
    </div>
    <div>
      <h2 id="vault-path" class="text-lg font-semibold text-white">
        {strings.status}
      </h2>
      <div class="flex items-center gap-2">
        <span id="connection-status" class="w-2 h-2 rounded-full bg-zinc-500"
        ></span>
        <p class="text-xs text-zinc-400">{strings.status_label}</p>
      </div>
    </div>
  </div>

  <!-- Actions & Identity -->
  <div class="flex items-center gap-3 w-full md:w-auto">
    <button
      id="select-vault-btn"
      class="hidden md:block px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm font-medium transition-colors"
    >
      {strings.open_folder}
    </button>

    <div class="h-8 w-px bg-white/10 hidden md:block"></div>

    <!-- Identity Profile (Compact) -->
    <div id="identity-section" class="flex items-center gap-3">
      <div class="text-right hidden md:block">
        <p id="identity-status" class="text-sm font-medium text-white">
          {strings.guest}
        </p>
        <p
          id="identity-badge"
          class="text-[10px] text-zinc-500 font-mono hidden"
        >
          Trusted
        </p>
      </div>

      <div class="relative group">
        <button id="identity-menu-btn" class="relative">
          <div
            id="identity-avatar-display"
            class="w-10 h-10 rounded-full bg-zinc-700 bg-cover bg-center border-2 border-white/10 group-hover:border-purple-500 transition-colors flex items-center justify-center text-xs text-zinc-400"
          >
            ?
          </div>
          <div
            class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-[#18181b] rounded-full hidden"
            id="online-indicator"
          >
          </div>
        </button>

        <!-- Dropdown Menu (Hidden by default, toggled via script or hover) -->
        <div
          class="absolute right-0 top-full mt-2 w-48 bg-zinc-900 border border-white/10 rounded-xl shadow-xl overflow-hidden hidden group-hover:block z-50"
        >
          <button
            id="edit-identity-btn"
            class="w-full text-left px-4 py-3 hover:bg-white/5 text-sm text-zinc-300 hidden"
          >
            {strings.edit_profile}
          </button>
          <button
            id="select-vault-mobile-btn"
            class="md:hidden w-full text-left px-4 py-3 hover:bg-white/5 text-sm text-zinc-300 border-t border-white/5"
          >
            {strings.switch_vault}
          </button>
        </div>
      </div>
    </div>
  </div>
</header>

<script define:vars={{ strings }}>
  window.vaultStrings = strings;
</script>

<script>
  import { identityStore } from "../../lib/stores/identity";
  import {
    getActiveHandle,
    openWorkspace,
    getLastVault,
    restoreSession,
  } from "../../lib/workspace";

  // Init Store
  identityStore.init();

  // DOM Elements
  const statusEl = document.getElementById("identity-status");
  const avatarEl = document.getElementById("identity-avatar-display");
  const editBtn = document.getElementById("edit-identity-btn");
  const onlineIndicator = document.getElementById("online-indicator");
  const badgeEl = document.getElementById("identity-badge");

  // Vault Elements
  const vaultPath = document.getElementById("vault-path");
  const connStatus = document.getElementById("connection-status");

  // Restore Session
  (async () => {
    // 1. Try to restore last vault
    const last = await getLastVault();
    if (last) {
      const success = await restoreSession(last.id);
      if (success) {
        updateVaultUI(last.name, true);
        window.dispatchEvent(new Event("workspace-restored")); // Notify other components

        // Refresh identity UI after vault restore (identity may be auto-created).
        identityStore.reload();
      } else {
        // Permission needed or not found
        updateVaultUI("Permission Needed", false);
      }
    }
  })();

  // Bridge for localized strings
  const strings = (window as any).vaultStrings;

  function updateVaultUI(name: string, active: boolean) {
    if (vaultPath)
      vaultPath.textContent =
        name === "Permission Needed" ? strings.permissionNeeded : name;
    if (connStatus) {
      connStatus.classList.toggle("bg-green-500", active);
      connStatus.classList.toggle("bg-zinc-500", !active);
    }
  }

  // Subscribe to store updates
  identityStore.subscribe(({ identity, loading }) => {
    if (!statusEl || !avatarEl) return;

    if (identity) {
      statusEl.textContent = identity.alias;
      if (badgeEl) badgeEl.classList.remove("hidden");

      if (identity.avatar) {
        const url = URL.createObjectURL(identity.avatar);
        avatarEl.style.backgroundImage = `url(${url})`;
        avatarEl.textContent = "";
      } else {
        avatarEl.style.backgroundImage = "";
        avatarEl.textContent = (identity.alias || "??")
          .slice(0, 2)
          .toUpperCase();
      }
      if (editBtn) editBtn.classList.remove("hidden");
      if (onlineIndicator) onlineIndicator.classList.remove("hidden"); // Assume "online" if identity exists for now
    } else {
      statusEl.textContent = loading ? strings.loading : strings.guest;
      if (badgeEl) badgeEl.classList.add("hidden");
      avatarEl.style.backgroundImage = "";
      avatarEl.textContent = "?";
      if (editBtn) editBtn.classList.add("hidden");
      if (onlineIndicator) onlineIndicator.classList.add("hidden");
    }
  });

  // Wire up events
  document
    .getElementById("select-vault-btn")
    ?.addEventListener("click", async () => {
      try {
        const res = await openWorkspace();
        if (res) {
          updateVaultUI(res.name, true);
          window.dispatchEvent(new Event("workspace-restored"));

          // Also trigger identity reload in case identity is in the new folder
          identityStore.reload();
        }
      } catch (e) {
        console.error(e);
      }
    });

  // Dropdown Logic
  const menuBtn = document.getElementById("identity-menu-btn");
  const dropdown = menuBtn?.nextElementSibling;

  if (menuBtn && dropdown) {
    menuBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      dropdown.classList.toggle("hidden");
    });

    document.addEventListener("click", () => {
      if (!dropdown.classList.contains("hidden")) {
        dropdown.classList.add("hidden");
      }
    });
    dropdown.addEventListener("click", (e) => e.stopPropagation());
  }

  // Edit/Create Dialog Triggers
  document
    .getElementById("edit-identity-btn")
    ?.addEventListener("click", () => {
      (document.getElementById("identity-dialog") as any)?.showModal();
      // We'll need to populate the form form the store in the Dialog component
      // Dispatch event "edit-identity" to let the dialog know.
      window.dispatchEvent(new CustomEvent("edit-identity"));
    });
</script>
