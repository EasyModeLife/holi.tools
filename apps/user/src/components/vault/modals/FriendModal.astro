---

---

<dialog
  id="friend-dialog"
  class="bg-zinc-900 rounded-2xl p-6 backdrop:bg-black/60 max-w-md w-full"
>
  <form id="friend-form" class="space-y-4">
    <h3 id="friend-dialog-title" class="text-xl font-bold text-white">
      Add Friend
    </h3>
    <input type="hidden" id="friend-id" name="id" />
    <div>
      <label for="friend-nostr-pubkey" class="block text-sm text-zinc-400 mb-1"
        >Friend Code (Public Key)</label
      >
      <input
        type="text"
        id="friend-nostr-pubkey"
        name="nostrPubkey"
        class="w-full px-4 py-2 bg-white/10 rounded-lg border border-white/10 text-white focus:border-purple-500 focus:outline-none font-mono text-xs"
        placeholder="64-hex key..."
        autocomplete="off"
        spellcheck="false"
      />
    </div>

    <div>
      <label for="friend-alias" class="block text-sm text-zinc-400 mb-1"
        >Name (Alias)</label
      >
      <input
        type="text"
        id="friend-alias"
        name="alias"
        required
        class="w-full px-4 py-2 bg-white/10 rounded-lg border border-white/10 text-white focus:border-purple-500 focus:outline-none"
        placeholder="Alice"
      />
    </div>

    <p class="text-xs text-zinc-500">
      Enter their code to add them. You can also just give them a name for a
      local-only entry.
    </p>
    <div class="flex gap-3 justify-end">
      <button
        type="button"
        id="cancel-friend-btn"
        class="px-4 py-2 text-zinc-400 hover:text-white transition-colors"
      >
        Cancel
      </button>
      <button
        type="submit"
        class="px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg font-medium transition-colors"
      >
        Save
      </button>
    </div>
  </form>
</dialog>

<script>
  import {
    addContact,
    addContactWithNostrPubkey,
    bindContactToNostrPubkey,
    renameContact,
    setContactDmByNostrPubkey,
  } from "../../../lib/contacts/store";
  import { getNostrPublicKey } from "../../../lib/p2p/nostr";
  import { getPrimaryIdentity } from "../../../lib/identity/manager";
  import { toast } from "../../../lib/ui/toast";
  import {
    isFriendCode,
    joinFriendRoom,
    type ContactInfo,
  } from "../../../lib/friends/friend-handshake";

  const dialog = document.getElementById("friend-dialog") as HTMLDialogElement;
  const form = document.getElementById("friend-form") as HTMLFormElement;
  const title = document.getElementById("friend-dialog-title");
  const idInput = document.getElementById("friend-id") as HTMLInputElement;
  const aliasContainer = document.getElementById("friend-alias")?.parentElement;
  const aliasInput = document.getElementById(
    "friend-alias"
  ) as HTMLInputElement;
  const pkInput = document.getElementById(
    "friend-nostr-pubkey"
  ) as HTMLInputElement;
  const submitBtn = form?.querySelector(
    'button[type="submit"]'
  ) as HTMLButtonElement;

  // Open Handler
  window.addEventListener("open-friend-modal", ((e: CustomEvent) => {
    const { mode, contact } = e.detail;

    form.reset();
    submitBtn.disabled = false;
    submitBtn.textContent = "Save";

    if (mode === "edit" && contact) {
      if (title) title.textContent = "Edit Friend";
      idInput.value = contact.id;
      aliasInput.value = contact.alias || "";
      pkInput.value = contact.nostrPubkey || "";
      pkInput.disabled = !!contact.nostrPubkey;
      if (aliasContainer) aliasContainer.classList.remove("hidden");
    } else {
      if (title) title.textContent = "Add Friend";
      idInput.value = "";
      pkInput.disabled = false;
      if (aliasContainer) aliasContainer.classList.remove("hidden");
    }
    dialog.showModal();
  }) as EventListener);

  // Dynamic UI: Hide Alias if Code is entered (Add Mode only)
  pkInput?.addEventListener("input", () => {
    const hasCode = !!pkInput.value.trim();
    const isAdd = !idInput.value;
    if (isAdd && aliasContainer) {
      if (hasCode) {
        aliasContainer.classList.add("hidden");
        aliasInput.required = false;
      } else {
        aliasContainer.classList.remove("hidden");
        aliasInput.required = true;
      }
    }
  });

  document
    .getElementById("cancel-friend-btn")
    ?.addEventListener("click", () => dialog.close());

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const id = idInput.value.trim();
    let alias = aliasInput.value.trim();
    const code = (pkInput?.value || "").trim();

    try {
      if (!id) {
        // ADD MODE
        if (code) {
          // Check if it's a Trystero Friend Code (holi-fr-...)
          if (isFriendCode(code)) {
            // Joining a friend's room
            submitBtn.disabled = true;
            submitBtn.textContent = "Connecting...";
            toast.info("Connecting to friend...");

            const myself = await getPrimaryIdentity();
            const myPk = await getNostrPublicKey();

            const myInfo: ContactInfo = {
              pubkey: myPk,
              name: myself?.alias || "Friend",
            };

            const peerInfo = await joinFriendRoom(code, myInfo, 60000); // 60s timeout

            if (!peerInfo?.dm?.sessionId || !peerInfo?.dm?.keyB64Url) {
              throw new Error(
                "Handshake succeeded but DM config was missing. Ask your friend to regenerate a new Friend Code."
              );
            }

            // Success! Add the contact
            await addContactWithNostrPubkey(peerInfo.name, peerInfo.pubkey);
            await setContactDmByNostrPubkey(peerInfo.pubkey, peerInfo.dm);

            toast.success(`Added ${peerInfo.name} as friend!`);
            dialog.close();
            window.dispatchEvent(new Event("reload-contacts"));
            return;
          } else {
            // Assume it's a 64-hex pubkey (legacy/fallback, local-only add)
            const pk = code.toLowerCase();
            const hexRegex = /^[0-9a-f]{64}$/;
            if (!hexRegex.test(pk)) {
              throw new Error(
                "Invalid code. Use a Friend Code (holi-fr-...) or 64-char hex key."
              );
            }
            const short = pk.slice(0, 4).toUpperCase();
            const autoAlias = `Pending (${short})`;
            await addContactWithNostrPubkey(autoAlias, pk);
            toast.success(
              "Contact added (local only). Ask them to share their Friend Code for connection."
            );
          }
        } else {
          // No code, just a name (local-only)
          if (!alias) throw new Error("Name is required");
          await addContact(alias);
          toast.success("Contact added (local only)");
        }
      } else {
        // EDIT MODE
        if (!alias) throw new Error("Name is required");
        await renameContact(id, alias);
        const pk = code.toLowerCase();
        if (pk && !pkInput.disabled) {
          await bindContactToNostrPubkey(id, pk);
          toast.success("Public Key bound to contact");
        } else {
          toast.success("Contact updated");
        }
      }

      dialog.close();
      window.dispatchEvent(new Event("reload-contacts"));
    } catch (err) {
      console.error(err);
      toast.error((err as Error).message);
      submitBtn.disabled = false;
      submitBtn.textContent = "Save";
    }
  });
</script>
