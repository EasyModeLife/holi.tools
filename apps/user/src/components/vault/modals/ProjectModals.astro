---
import { getLangFromUrl, useTranslations } from "../../../i18n/utils";
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const strings = {
  new_title: t("projects.new_title"),
  label_name: t("projects.label_name"),
  placeholder_name: t("projects.placeholder_name"),
  btn_create: t("projects.btn_create"),
  btn_cancel: t("friends.btn_cancel"),
  join_title: t("projects.join_title"),
  join_desc: t("projects.join_desc"),
  label_code: t("projects.label_code"),
  placeholder_code: t("projects.placeholder_code"),
  btn_join: t("projects.btn_join"),
  manage_title: t("projects.manage_title"),
  manage_desc: t("projects.manage_desc"),
  label_settings: t("projects.label_settings"),
  label_auto_admit: t("projects.label_auto_admit"),
  desc_auto_admit: t("projects.desc_auto_admit"),
  label_offline: t("projects.label_offline"),
  desc_offline: t("projects.desc_offline"),
  label_collaborators: t("projects.label_collaborators"),
  btn_add_collab: t("projects.btn_add_collab"),
  no_collaborators: t("projects.no_collaborators"),
  btn_remove: t("projects.btn_remove"),
  label_owner: t("projects.label_owner"),
  msg_created: t("projects.msg_created"),
  error_invite: t("projects.error_invite"),
  msg_settings_saved: t("projects.msg_settings_saved"),
  msg_collab_removed: t("projects.msg_collab_removed"),
  prompt_pubkey: t("projects.prompt_pubkey"),
  msg_collab_added: t("projects.msg_collab_added"),
  error_add_collab: t("projects.error_add_collab"),
  confirm_remove: t("projects.confirm_remove"),
};
---

<!-- New Project Modal -->
<dialog
  id="new-project-dialog"
  class="bg-zinc-900 rounded-2xl p-6 backdrop:bg-black/60 max-w-md w-full"
>
  <form id="new-project-form" class="space-y-4">
    <h3 class="text-xl font-bold text-white">{strings.new_title}</h3>
    <div>
      <label for="project-name" class="block text-sm text-zinc-400 mb-1"
        >{strings.label_name}</label
      >
      <input
        type="text"
        id="project-name"
        name="name"
        required
        class="w-full px-4 py-2 bg-white/10 rounded-lg border border-white/10 text-white focus:border-purple-500 focus:outline-none"
        placeholder={strings.placeholder_name}
      />
    </div>
    <div class="flex gap-3 justify-end">
      <button
        type="button"
        id="cancel-project-btn"
        class="px-4 py-2 text-zinc-400 hover:text-white transition-colors"
      >
        {strings.btn_cancel}
      </button>
      <button
        type="submit"
        class="px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg font-medium transition-colors"
      >
        {strings.btn_create}
      </button>
    </div>
  </form>
</dialog>

<!-- Join Project Modal -->
<dialog
  id="join-project-dialog"
  class="bg-zinc-900 rounded-2xl p-6 backdrop:bg-black/60 max-w-md w-full"
>
  <form id="join-project-form" class="space-y-4">
    <h3 class="text-xl font-bold text-white">{strings.join_title}</h3>
    <p class="text-sm text-zinc-400">
      {strings.join_desc}
    </p>
    <div>
      <label for="project-code" class="block text-sm text-zinc-400 mb-1"
        >{strings.label_code}</label
      >
      <input
        type="text"
        id="project-code"
        name="code"
        required
        class="w-full px-4 py-2 bg-white/10 rounded-lg border border-white/10 text-white focus:border-purple-500 focus:outline-none font-mono text-sm"
        placeholder={strings.placeholder_code}
        autocomplete="off"
      />
    </div>
    <div class="flex gap-3 justify-end">
      <button
        type="button"
        id="cancel-join-btn"
        class="px-4 py-2 text-zinc-400 hover:text-white transition-colors"
      >
        {strings.btn_cancel}
      </button>
      <button
        type="submit"
        class="px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg font-medium transition-colors"
      >
        {strings.btn_join}
      </button>
    </div>
  </form>
</dialog>

<!-- Manage Project Modal -->
<dialog
  id="manage-project-dialog"
  class="bg-zinc-900 rounded-2xl p-6 backdrop:bg-black/60 max-w-2xl w-full"
>
  <div class="space-y-6">
    <div class="flex items-start justify-between">
      <div>
        <h3 id="manage-project-title" class="text-xl font-bold text-white">
          {strings.manage_title}
        </h3>
        <p class="text-xs text-zinc-500 mt-1">{strings.manage_desc}</p>
      </div>
      <button
        type="button"
        id="close-manage-project-btn"
        class="px-3 py-1 text-zinc-400 hover:text-white transition-colors"
      >
        {t("friends.btn_close")}
      </button>
    </div>

    <!-- Settings -->
    <div class="space-y-3 p-4 bg-white/5 rounded-xl border border-white/5">
      <h4 class="text-sm font-semibold text-white">{strings.label_settings}</h4>

      <label class="flex items-center justify-between cursor-pointer">
        <span class="text-sm text-zinc-300">{strings.label_auto_admit}</span>
        <input
          type="checkbox"
          id="manage-project-autoadmit"
          class="toggle-checkbox"
        />
      </label>
      <p class="text-xs text-zinc-500">
        {strings.desc_auto_admit}
      </p>

      <label class="flex items-center justify-between cursor-pointer mt-2">
        <span class="text-sm text-zinc-300">{strings.label_offline}</span>
        <input
          type="checkbox"
          id="manage-project-offline"
          class="toggle-checkbox"
        />
      </label>
      <p class="text-xs text-zinc-500">
        {strings.desc_offline}
      </p>
    </div>

    <!-- Collaborators -->
    <div class="space-y-3">
      <div class="flex items-center justify-between">
        <h4 class="text-sm font-semibold text-white">
          {strings.label_collaborators}
        </h4>
        <button
          type="button"
          id="add-collaborator-btn"
          class="px-3 py-1 text-xs bg-purple-600 hover:bg-purple-500 rounded-lg text-white transition-colors"
        >
          {strings.btn_add_collab}
        </button>
      </div>

      <div id="collaborators-list" class="space-y-2 max-h-60 overflow-y-auto">
        <p class="text-xs text-zinc-500 italic">{strings.no_collaborators}</p>
      </div>
    </div>
  </div>
</dialog>

<script define:vars={{ strings }}>
  window.projectModalStrings = strings;
</script>

<script>
  const strings = (window as any).projectModalStrings;
  import {
    createProject,
    getProject,
    type ProjectCollaborator,
  } from "../../../lib/projects/manager";
  import {
    addCollaborator,
    removeCollaborator,
    updateProjectSettings,
  } from "../../../lib/projects/collaboration";
  import { toast } from "../../../lib/ui/toast";

  function parseVaultInvite(
    input: string
  ): { projectId: string; secret: string } | null {
    const trimmed = input.trim();
    if (!trimmed) return null;

    // Accept:
    // - https://host/vault#<projectId>.<secret>
    // - /vault#<projectId>.<secret>
    // - vault#<projectId>.<secret>
    // - <projectId>.<secret>
    const hashIndex = trimmed.indexOf("#");
    const fragment = (
      hashIndex >= 0 ? trimmed.slice(hashIndex + 1) : trimmed
    ).trim();
    const cleaned = fragment.startsWith("vault#")
      ? fragment.slice("vault#".length)
      : fragment;

    const [projectId, secret, ...rest] = cleaned.split(".");
    if (!projectId || !secret || rest.length > 0) return null;

    // Light validation (don’t over-restrict; project ids may vary)
    if (!/^[a-zA-Z0-9_-]{6,}$/.test(projectId)) return null;
    // Accept base64 and base64url (projectMasterKey is currently base64)
    if (!/^[-_a-zA-Z0-9+/=]{16,}$/.test(secret)) return null;

    return { projectId, secret };
  }

  // New Project Logic
  const newDialog = document.getElementById(
    "new-project-dialog"
  ) as HTMLDialogElement;
  const newForm = document.getElementById(
    "new-project-form"
  ) as HTMLFormElement;

  document
    .getElementById("cancel-project-btn")
    ?.addEventListener("click", () => newDialog.close());

  newForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(newForm);
    const name = formData.get("name") as string;
    try {
      await createProject(name);
      toast.success(strings.msg_created.replace("{name}", name));
      newDialog.close();
      newForm.reset();
      window.dispatchEvent(new Event("repo-changed")); // Signal to reload list
    } catch (err) {
      console.error(err);
      toast.error((err as Error).message);
    }
  });

  // Join Project Logic
  const joinDialog = document.getElementById(
    "join-project-dialog"
  ) as HTMLDialogElement;
  const joinForm = document.getElementById(
    "join-project-form"
  ) as HTMLFormElement;

  document
    .getElementById("cancel-join-btn")
    ?.addEventListener("click", () => joinDialog.close());

  joinForm?.addEventListener("submit", (e) => {
    e.preventDefault();
    const formData = new FormData(joinForm);
    const code = (formData.get("code") as string).trim();
    const parsed = parseVaultInvite(code);

    if (!parsed) {
      toast.error(strings.error_invite);
      return;
    }

    // Redirect
    window.location.href = `/vault#${parsed.projectId}.${parsed.secret}`;
  });

  // Manage Project Logic
  let currentManagingProjectId: string | null = null;
  const manageDialog = document.getElementById(
    "manage-project-dialog"
  ) as HTMLDialogElement;
  const manageTitle = document.getElementById("manage-project-title");
  const autoAdmit = document.getElementById(
    "manage-project-autoadmit"
  ) as HTMLInputElement;
  const offline = document.getElementById(
    "manage-project-offline"
  ) as HTMLInputElement;

  document
    .getElementById("close-manage-project-btn")
    ?.addEventListener("click", () => {
      manageDialog.close();
      window.dispatchEvent(new Event("repo-changed"));
    });

  // Listenlers for opening modals
  window.addEventListener("open-project-modal", ((e: any) => {
    const { mode } = e.detail;
    if (mode === "create") newDialog.showModal();
    if (mode === "join") joinDialog.showModal();
  }) as EventListener);

  window.addEventListener("open-manage-project", (async (e: any) => {
    const { id } = e.detail;
    currentManagingProjectId = id;

    const project = await getProject(id);
    if (!project) return;

    if (manageTitle)
      manageTitle.textContent = `${strings.manage_title}: ${project.name}`;

    // Populate Settings
    if (autoAdmit) {
      autoAdmit.checked = !!project.settings?.autoAdmit;
      const newEl = autoAdmit.cloneNode(true) as HTMLInputElement;
      autoAdmit.parentNode?.replaceChild(newEl, autoAdmit);
      newEl.onchange = async () => {
        await updateProjectSettings(id, { autoAdmit: newEl.checked });
        toast.success(strings.msg_settings_saved);
      };
    }

    if (offline) {
      offline.checked = !!project.settings?.allowOfflineEditing;
      const newEl = offline.cloneNode(true) as HTMLInputElement;
      offline.parentNode?.replaceChild(newEl, offline);
      newEl.onchange = async () => {
        await updateProjectSettings(id, { allowOfflineEditing: newEl.checked });
        toast.success(strings.msg_settings_saved);
      };
    }

    renderCollaborators(project.collaborators || []);
    manageDialog.showModal();
  }) as EventListener);

  function renderCollaborators(collaborators: ProjectCollaborator[]) {
    const list = document.getElementById("collaborators-list");
    if (!list) return;

    if (collaborators.length === 0) {
      list.innerHTML = `<p class="text-xs text-zinc-500 italic">${strings.no_collaborators}</p>`;
      return;
    }

    list.innerHTML = "";
    collaborators.forEach((c) => {
      const row = document.createElement("div");
      row.className =
        "flex items-center justify-between p-2 bg-white/5 rounded-lg border border-white/5";

      const info = document.createElement("div");
      info.innerHTML = `
                <div class="text-sm font-medium text-white">${c.name}</div>
                <div class="text-xs text-zinc-500 font-mono">${c.did.slice(0, 8)}... • ${c.role}</div>
            `;

      const actions = document.createElement("div");
      if (c.role !== "owner") {
        const rmBtn = document.createElement("button");
        rmBtn.textContent = strings.btn_remove;
        rmBtn.className =
          "text-xs text-red-400 hover:text-red-300 px-2 py-1 bg-red-500/10 hover:bg-red-500/20 rounded";
        rmBtn.onclick = async () => {
          if (!currentManagingProjectId) return;
          if (confirm(strings.confirm_remove.replace("{name}", c.name))) {
            await removeCollaborator(currentManagingProjectId, c.did);
            const p = await getProject(currentManagingProjectId);
            if (p) renderCollaborators(p.collaborators);
            toast.success(strings.msg_collab_removed);
          }
        };
        actions.appendChild(rmBtn);
      } else {
        const badge = document.createElement("span");
        badge.className =
          "text-xs text-purple-400 bg-purple-500/10 px-2 py-0.5 rounded";
        badge.textContent = strings.label_owner;
        actions.appendChild(badge);
      }

      row.appendChild(info);
      row.appendChild(actions);
      list.appendChild(row);
    });
  }

  document
    .getElementById("add-collaborator-btn")
    ?.addEventListener("click", async () => {
      if (!currentManagingProjectId) return;
      const pubkey = prompt(strings.prompt_pubkey);
      if (!pubkey) return;
      try {
        await addCollaborator(currentManagingProjectId, {
          did: pubkey,
          role: "editor",
          name: "Guest",
          addedAt: Date.now(),
        });
        const p = await getProject(currentManagingProjectId);
        if (p) renderCollaborators(p.collaborators);
        toast.success(strings.msg_collab_added);
      } catch (e) {
        console.error(e);
        toast.error(strings.error_add_collab);
      }
    });
</script>
