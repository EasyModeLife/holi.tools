---

---

<section id="friends-section" class="space-y-4">
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
    <div class="flex items-center gap-3">
      <h3 class="text-lg font-bold text-white">Friends</h3>
      <span
        id="friend-count"
        class="px-2 py-0.5 rounded-md bg-white/5 text-xs text-zinc-500">0</span
      >
    </div>

    <!-- Filter & Actions -->
    <div class="flex items-center gap-2 w-full md:w-auto">
      <div class="relative flex-1 md:w-64">
        <input
          type="text"
          id="friend-search"
          placeholder="Search friends..."
          class="w-full pl-8 pr-3 py-1.5 bg-white/5 border border-white/10 rounded-lg text-xs text-white focus:border-purple-500 focus:outline-none transition-colors"
        />
        <svg
          class="absolute left-2.5 top-1.5 text-zinc-500 w-3.5 h-3.5"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          ><path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg
        >
      </div>

      <button
        id="toggle-blocked-btn"
        class="p-1.5 bg-white/5 hover:bg-white/10 rounded-lg text-zinc-400 hover:text-white transition-colors"
        title="Toggle Blocked Friends"
        data-showing="false"
      >
        <svg
          class="w-4 h-4"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          ><path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"
          ></path></svg
        >
      </button>

      <div class="h-6 w-px bg-white/10 mx-1"></div>

      <button
        id="copy-friend-code-btn"
        class="hidden p-1.5 bg-white/5 hover:bg-white/10 rounded-lg text-zinc-300 transition-colors"
        title="Copy My Friend Code"
      >
        <svg
          class="w-4 h-4"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          ><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path
            d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
          ></path></svg
        >
      </button>
      <button
        id="add-friend-btn"
        class="px-3 py-1.5 bg-purple-600 hover:bg-purple-500 rounded-lg text-xs font-medium text-white transition-colors disabled:opacity-50 whitespace-nowrap"
        disabled
      >
        + Add
      </button>
    </div>
  </div>

  <div
    id="no-friends-warning"
    class="hidden p-4 rounded-xl bg-yellow-500/10 border border-yellow-500/20 text-sm text-yellow-400"
  >
    ⚠️ Open a local folder to manage friends.
  </div>

  <!-- Friends List Container -->
  <div id="friends-list" class="space-y-2">
    <p class="text-xs text-zinc-500 italic p-4 text-center">
      Loading friends...
    </p>
  </div>
</section>

<script>
  import { listContacts, setContactState } from "../../lib/contacts/store";
  import { identityStore } from "../../lib/stores/identity";
  import { toast } from "../../lib/ui/toast";

  // Note: openFriendDialog is handled via Custom Events

  // Note: openFriendDialog is likely a function exported from the script logic or handled via event.
  // For now, we will dispatch events to open global modals or implement logic here.

  let contacts: any[] = [];
  let showBlocked = false;
  let friendSearchQuery = "";
  let myPubkey = "";

  const listEl = document.getElementById("friends-list");
  const countEl = document.getElementById("friend-count");
  const addBtn = document.getElementById("add-friend-btn") as HTMLButtonElement;
  const copyBtn = document.getElementById("copy-friend-code-btn");
  const searchInput = document.getElementById(
    "friend-search"
  ) as HTMLInputElement;
  const toggleBlockedBtn = document.getElementById("toggle-blocked-btn");

  identityStore.subscribe(({ pubkey, identity }) => {
    myPubkey = pubkey || "";
    // addBtn state is managed by loadContacts() based on workspace availability
    // identity logic mostly affects invites but for adding friends, we just need a vault.

    if (copyBtn) {
      if (pubkey) copyBtn.classList.remove("hidden");
      else copyBtn.classList.add("hidden");
    }
  });

  // Event Listeners
  addBtn?.addEventListener("click", () => {
    // Dispatch event to open Friend Modal
    window.dispatchEvent(
      new CustomEvent("open-friend-modal", { detail: { mode: "add" } })
    );
  });

  // State for hosting
  let isHosting = false;
  let activeRoom: { leave: () => void } | null = null;

  copyBtn?.addEventListener("click", async () => {
    if (!myPubkey) return;
    if (isHosting) {
      // Already hosting, just copy
      toast.info("Code already copied. Waiting for friend...");
      return;
    }

    // Import handshake
    const { generateFriendCode, hostFriendRoom } =
      await import("../../lib/friends/friend-handshake");
    const { getPrimaryIdentity } = await import("../../lib/identity/manager");
    const { getNostrPublicKey } = await import("../../lib/p2p/nostr");
    const { generateDmConfig } = await import("../../lib/friends/dm");
    const { addContactWithNostrPubkey, setContactDmByNostrPubkey } =
      await import("../../lib/contacts/store");

    const code = generateFriendCode();
    await navigator.clipboard.writeText(code);
    toast.success("Friend Code copied! Waiting for friend to join...");

    // Start hosting
    isHosting = true;
    copyBtn.classList.add("animate-pulse", "text-green-400");

    const myself = await getPrimaryIdentity();
    const pk = await getNostrPublicKey();
    const dm = generateDmConfig();

    const myInfo = {
      pubkey: pk,
      name: myself?.alias || "Friend",
      dm,
    };

    activeRoom = hostFriendRoom(code, myInfo, async (peerInfo) => {
      // Peer connected!
      toast.success(`${peerInfo.name} connected! Adding as friend...`);

      await addContactWithNostrPubkey(peerInfo.name, peerInfo.pubkey);
      // Important: use the HOST-generated dm config so both sides share the same room secret.
      await setContactDmByNostrPubkey(peerInfo.pubkey, dm);

      // Cleanup
      isHosting = false;
      copyBtn.classList.remove("animate-pulse", "text-green-400");
      if (activeRoom) {
        activeRoom.leave();
        activeRoom = null;
      }

      window.dispatchEvent(new Event("reload-contacts"));
    });

    // Auto-timeout after 2 minutes
    setTimeout(() => {
      if (isHosting) {
        isHosting = false;
        copyBtn.classList.remove("animate-pulse", "text-green-400");
        if (activeRoom) {
          activeRoom.leave();
          activeRoom = null;
        }
        toast.info("Friend Code expired. Generate a new one.");
      }
    }, 120000);
  });

  searchInput?.addEventListener("input", (e) => {
    friendSearchQuery = (e.target as HTMLInputElement).value.toLowerCase();
    renderContacts();
  });

  toggleBlockedBtn?.addEventListener("click", () => {
    showBlocked = !showBlocked;
    toggleBlockedBtn.classList.toggle("text-purple-400", showBlocked);
    toggleBlockedBtn.classList.toggle("bg-purple-500/10", showBlocked);
    renderContacts();
  });

  // Expose load logic
  export async function loadContacts() {
    if (!listEl) return;

    // Check if workspace is active
    const { getActiveHandle } = await import("../../lib/workspace");
    if (!getActiveHandle()) {
      listEl.innerHTML =
        '<p class="text-xs text-zinc-500 italic p-4 text-center">No vault open.</p>';
      if (addBtn) addBtn.disabled = true;
      return;
    }

    try {
      listEl.innerHTML =
        '<p class="text-xs text-zinc-500 italic animate-pulse p-4 text-center">Loading...</p>';
      contacts = await listContacts();
      renderContacts();
      if (addBtn) addBtn.disabled = false;
    } catch (e) {
      console.error(e);
      listEl.innerHTML =
        '<p class="text-xs text-red-400 p-4 text-center">Failed to load friends</p>';
    }
  }

  // Export for parent to call active reload
  window.addEventListener("workspace-restored", loadContacts);
  window.addEventListener("reload-contacts", loadContacts);

  function renderContacts() {
    if (!listEl) return;

    const filtered = contacts.filter((c) => {
      if (!showBlocked && c.state === "blocked") return false;
      if (friendSearchQuery) {
        const key = (c.nostrPubkey || "").toLowerCase();
        const name = c.alias.toLowerCase();
        return (
          name.includes(friendSearchQuery) || key.includes(friendSearchQuery)
        );
      }
      return true;
    });

    if (countEl) countEl.textContent = String(filtered.length);

    if (filtered.length === 0) {
      listEl.innerHTML =
        '<p class="text-xs text-zinc-500 italic p-4 text-center">No matches.</p>';
      return;
    }

    listEl.innerHTML = "";
    listEl.classList.add("grid", "grid-cols-1", "gap-2");

    for (const c of filtered) {
      const row = document.createElement("div");
      row.className =
        "group flex items-center justify-between p-3 bg-white/5 rounded-xl border border-white/5 hover:bg-white/10 transition-all hover:shadow-lg hover:border-white/10";

      // ... DOM construction (copied from Dashboard with minor tweaks)

      // Avatar & Info
      const left = document.createElement("div");
      left.className = "flex items-center gap-3 min-w-0";

      const avatar = document.createElement("div");
      avatar.className =
        "w-10 h-10 rounded-full bg-zinc-800 flex items-center justify-center text-sm font-bold text-zinc-400 border border-white/10";
      avatar.textContent = c.alias.slice(0, 2).toUpperCase();

      const info = document.createElement("div");
      info.className = "min-w-0";

      const nameRow = document.createElement("div");
      nameRow.className = "flex items-center gap-2";
      const name = document.createElement("span");
      name.className = "text-sm text-white font-medium truncate";
      name.textContent = c.alias;
      nameRow.appendChild(name);

      const tag = document.createElement("div");
      tag.className = "text-xs text-zinc-500 font-mono truncate";
      const shortKey = c.nostrPubkey
        ? c.nostrPubkey.slice(0, 8) + "..." + c.nostrPubkey.slice(-4)
        : "Local Only";
      tag.textContent =
        c.state === "blocked" ? "Blocked • " + shortKey : shortKey;

      info.appendChild(nameRow);
      info.appendChild(tag);

      left.appendChild(avatar);
      left.appendChild(info);

      // Actions
      const actions = document.createElement("div");
      actions.className = "flex gap-2 items-center";

      // Status Dropdown (Simplified for this file)
      const statusContainer = document.createElement("div");
      statusContainer.className = "relative";
      const statusBtn = document.createElement("button");
      const statusColor =
        c.state === "active"
          ? "bg-green-500/20 text-green-400"
          : c.state === "paused"
            ? "bg-yellow-500/20 text-yellow-400"
            : "bg-red-500/20 text-red-400";
      statusBtn.className = `px-2 py-1 text-xs rounded-md font-medium transition-colors flex items-center gap-1 ${statusColor}`;

      const displayState =
        c.state === "active"
          ? "Trusted"
          : c.state.charAt(0).toUpperCase() + c.state.slice(1);
      statusBtn.innerHTML = `<span>${displayState}</span><svg class="w-3 h-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;

      statusBtn.onclick = (e) => {
        e.stopPropagation();
        document.querySelectorAll(".status-menu").forEach((el) => el.remove());
        const menu = document.createElement("div");
        menu.className =
          "status-menu absolute right-0 top-full mt-1 w-24 bg-zinc-900 border border-white/10 rounded-lg shadow-xl overflow-hidden z-10";
        ["active", "paused", "blocked"].forEach((state) => {
          if (state === c.state) return;
          const item = document.createElement("button");
          item.className =
            "w-full text-left px-3 py-2 text-xs hover:bg-white/10 text-zinc-300 capitalize";
          item.textContent = state === "active" ? "Trusted" : state;
          item.onclick = async () => {
            await setContactState(c.id, state as any);
            toast.info(
              `Contact marked as ${state === "active" ? "Trusted" : state}`
            );
            menu.remove();
            await loadContacts();
          };
          menu.appendChild(item);
        });
        const closeMenu = () => {
          menu.remove();
          document.removeEventListener("click", closeMenu);
        };
        setTimeout(() => document.addEventListener("click", closeMenu), 0);
        statusContainer.appendChild(menu);
      };
      statusContainer.appendChild(statusBtn);

      // Chat Button
      const chatBtn = document.createElement("button");
      chatBtn.className = `p-2 rounded-lg transition-colors ${c.nostrPubkey ? "text-zinc-400 hover:text-white hover:bg-white/10" : "text-zinc-600 cursor-not-allowed"}`;
      chatBtn.innerHTML = `<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>`;
      if (c.nostrPubkey) {
        chatBtn.onclick = () =>
          (window.location.href = `/dm#pk=${c.nostrPubkey}`);
      }

      // Edit Button (Rename)
      const editBtn = document.createElement("button");
      editBtn.className =
        "p-2 rounded-lg text-zinc-400 hover:text-white hover:bg-white/10 transition-colors";
      editBtn.innerHTML = `<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>`;
      editBtn.onclick = () => {
        window.dispatchEvent(
          new CustomEvent("open-friend-modal", {
            detail: { mode: "edit", contact: c },
          })
        );
      };

      // Delete Button
      const deleteBtn = document.createElement("button");
      deleteBtn.className =
        "p-2 rounded-lg text-zinc-400 hover:text-red-400 hover:bg-red-500/10 transition-colors";
      deleteBtn.innerHTML = `<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>`;
      deleteBtn.onclick = async () => {
        if (confirm(`Delete ${c.alias}?`)) {
          const { removeContact } = await import("../../lib/contacts/store");
          await removeContact(c.id);
          toast.success("Contact removed");
          loadContacts();
        }
      };

      actions.appendChild(statusContainer);
      actions.appendChild(chatBtn);
      actions.appendChild(editBtn);
      actions.appendChild(deleteBtn);

      row.appendChild(left);
      row.appendChild(actions);
      listEl.appendChild(row);
    }
  }

  // Initial Load
  loadContacts();
</script>
