---

---

<section id="projects-section" class="space-y-4 pt-4 border-t border-white/5">
  <div class="flex items-center justify-between">
    <h3 class="text-lg font-bold text-white">Projects</h3>
    <div class="flex items-center gap-2">
      <button
        id="join-project-btn"
        class="px-3 py-1.5 bg-white/5 hover:bg-white/10 rounded-lg text-xs font-medium text-zinc-300 transition-colors disabled:opacity-50"
        disabled
      >
        Join via Code
      </button>
      <button
        id="new-project-btn"
        class="px-3 py-1.5 bg-purple-600 hover:bg-purple-500 rounded-lg text-xs font-medium text-white transition-colors disabled:opacity-50"
        disabled
      >
        + New Project
      </button>
    </div>
  </div>

  <div
    id="projects-grid"
    class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"
  >
    <div class="skeleton-card animate-pulse bg-white/5 rounded-xl h-32"></div>
  </div>

  <div
    id="empty-projects"
    class="hidden text-center py-8 text-zinc-500 text-sm"
  >
    <p>No projects yet.</p>
  </div>
</section>

<script>
  import { getProjects, deleteProject } from "../../lib/projects/manager";
  import { toast } from "../../lib/ui/toast";
  import { getActiveHandle } from "../../lib/workspace";

  // Replicate logic for project loading
  let projects: any[] = [];
  const grid = document.getElementById("projects-grid");
  const empty = document.getElementById("empty-projects");
  const newBtn = document.getElementById(
    "new-project-btn"
  ) as HTMLButtonElement;
  const joinBtn = document.getElementById(
    "join-project-btn"
  ) as HTMLButtonElement;

  // Enable buttons if workspace is active
  if (getActiveHandle()) {
    newBtn.disabled = false;
    joinBtn.disabled = false;
  }

  newBtn?.addEventListener("click", () => {
    window.dispatchEvent(
      new CustomEvent("open-project-modal", { detail: { mode: "create" } })
    );
  });

  joinBtn?.addEventListener("click", () => {
    window.dispatchEvent(
      new CustomEvent("open-project-modal", { detail: { mode: "join" } })
    );
  });

  export async function loadProjects() {
    if (!grid) return;

    if (!getActiveHandle()) {
      grid.classList.add("hidden");
      empty?.classList.add("hidden");
      // Maybe show a 'No vault' message or just nothing until vault is open
      return;
    }

    try {
      const list = await getProjects();
      projects = list;

      if (projects.length === 0) {
        grid.innerHTML = "";
        grid.classList.add("hidden");
        empty?.classList.remove("hidden");
        return;
      }

      empty?.classList.add("hidden");
      grid.classList.remove("hidden");
      grid.innerHTML = "";

      for (const p of projects) {
        const card = document.createElement("div");
        card.className =
          "project-card group relative bg-white/5 border border-white/5 p-5 rounded-2xl hover:bg-white/10 transition-all hover:shadow-xl hover:-translate-y-1 overflow-hidden";
        // ... (Card HTML generation copied from Dashboard, replacing alerts with Toasts)

        card.innerHTML = `
                    <div class="absolute top-0 right-0 p-3 opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                        <button class="project-manage-btn p-1.5 rounded-lg bg-zinc-800 text-zinc-400 hover:text-white" title="Settings" data-id="${p.id}">
                            <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        </button>
                        <button class="project-delete-btn p-1.5 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500/20" title="Delete" data-id="${p.id}">
                            <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>

                    <div class="mb-4">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="p-1.5 rounded-lg bg-purple-500/20 text-purple-400">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                            </span>
                            <span class="text-xs uppercase tracking-wider text-purple-400 font-bold">Project</span>
                        </div>
                        <h4 class="text-white font-bold text-lg leading-tight truncate px-1">${p.name}</h4>
                        <div class="flex items-center gap-2 mt-2 px-1">
                            <span class="text-[10px] font-mono text-zinc-500 bg-white/5 px-1.5 py-0.5 rounded">${p.role || "owner"}</span>
                            <span class="text-[10px] font-mono text-zinc-500">${new Date(p.updatedAt).toLocaleDateString()}</span>
                        </div>
                    </div>

                    <div class="flex items-center justify-between pt-4 border-t border-white/5">
                        <span class="text-xs text-zinc-500 flex items-center gap-1.5">
                            <span class="w-1.5 h-1.5 rounded-full bg-zinc-600"></span>
                            Offline
                        </span>
                        
                        <button class="project-chat-btn text-xs text-zinc-400 hover:text-white flex items-center gap-1 group/chat px-2 py-1 rounded-md hover:bg-white/5 transition-colors" data-id="${p.id}">
                            <svg class="w-3.5 h-3.5 group-hover/chat:text-purple-400 transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                            Chat
                        </button>
                    </div>
                 `;

        card.addEventListener("click", (e) => {
          // Check if clicked button
          if ((e.target as HTMLElement).closest("button")) return;
          window.location.href = `/vault#${p.id}`;
        });

        // Wire buttons
        const manageBtn = card.querySelector(".project-manage-btn");
        manageBtn?.addEventListener("click", (e) => {
          e.stopPropagation();
          window.dispatchEvent(
            new CustomEvent("open-manage-project", { detail: { id: p.id } })
          );
        });

        const chatBtn = card.querySelector(".project-chat-btn");
        chatBtn?.addEventListener("click", (e) => {
          e.stopPropagation();
          window.location.href = `/vault?chat=1#${p.id}`;
        });

        const delBtn = card.querySelector(".project-delete-btn");
        delBtn?.addEventListener("click", async (e) => {
          e.stopPropagation();
          if (confirm(`Delete ${p.name}?`)) {
            await deleteProject(p.id);
            toast.success("Project deleted");
            loadProjects();
          }
        });

        grid.appendChild(card);
      }
    } catch (e) {
      console.error(e);
      toast.error("Failed to load projects");
    }
  }

  // Export active reloader
  window.addEventListener("repo-changed", loadProjects); // Custom event if needed
  window.addEventListener("workspace-restored", loadProjects);
  loadProjects();
</script>

<style>
  .project-card {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
  }
</style>
