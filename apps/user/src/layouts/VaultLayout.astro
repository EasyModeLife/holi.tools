---
import { ViewTransitions } from "astro:transitions";
import "../styles/global.css";

import ConfigMenu from "@holi/ui/components/ConfigMenu.astro";
import VersionBadge from "@holi/ui/components/VersionBadge.astro";
import ChangelogOverlay from "@holi/ui/components/ChangelogOverlay.astro";

import InfoOverlay from "../components/InfoOverlay.astro";

import { getTranslations, languages } from "../i18n/translations";
import { userAppChangelog } from "@holi/configs/changelogs";
import pkg from "../../package.json";

interface Props {
  title?: string;
  description?: string;
}

const { title = "Holi Identity Vault", description } = Astro.props;
const lang = Astro.currentLocale || "en";

const homeHref = lang === "en" ? "/" : `/${lang}/`;

const version = (pkg as any).version as string | undefined;
const history = (userAppChangelog as any)[lang] || userAppChangelog.en;
const t = getTranslations(lang);
---

<html lang={lang} class="dark bg-zinc-950 text-white">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <ViewTransitions />
    <script is:inline>
      // Force unregister any zombie service workers (e.g. from apps/main running on same port)
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .getRegistrations()
          .then(function (registrations) {
            for (let registration of registrations) {
              console.log(
                "[Layout] Unregistering zombie service worker:",
                registration.scope
              );
              registration.unregister();
            }
          });
      }
    </script>
  </head>
  <body
    class="min-h-screen flex flex-col antialiased selection:bg-purple-500/30"
  >
    <div style="position: fixed; top: 20px; right: 20px; z-index: 9000;">
      <ConfigMenu
        currentLang={lang}
        languages={languages}
        homeHref={homeHref}
        changelogId={version ? "user" : undefined}
      />
    </div>

    <main class="flex-1 w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <slot />
    </main>

    <footer
      class="border-t border-white/10 py-6 text-center text-sm text-zinc-500"
    >
      <p>Secure Identity Vault &copy; {new Date().getFullYear()}</p>
    </footer>

    {version && <VersionBadge version={version} changelogId="user" />}
    {version && history && (
      <ChangelogOverlay
        id="user"
        currentVersion={version}
        history={history}
        labels={{
          title: t.changelog_title,
          current: t.changelog_current,
          footer: t.changelog_footer,
        }}
      />
    )}

    <InfoOverlay lang={lang} />
  </body>
</html>
